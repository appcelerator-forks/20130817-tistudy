[{"id":24627,"uuid":"e46be8ae66064f1f4657","user":{"id":15632,"url_name":"kidapu","profile_image_url":"https://twimg0-a.akamaihd.net/profile_images/2048848110/image_normal.jpg"},"title":"Cloud Watch カスタマイズ on Cent5.6","created_at":"2013-08-14 11:47:08 +0900","updated_at":"2013-08-14 11:54:01 +0900","created_at_in_words":"8分前","updated_at_in_words":"1分前","tags":[{"name":"ShellScript","url_name":"shellscript","icon_url":"https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/6775262832b410128932fe1c84b8c7f5a1f33cd5/medium.jpg?1364837762","versions":[]}],"stock_count":0,"stock_users":[],"comment_count":0,"lgtm_count":0,"url":"http://qiita.com/kidapu/items/e46be8ae66064f1f4657","gist_url":null,"tweet":false,"private":false,"created_at_as_seconds":1376448428,"raw_body":"以下、記事にしたがって、Cloud Watchをカスタマイズしようと思った。\nhttp://thinking.ne.jp/2013/01/aws-cloudwatch-ec2/\n\nら、２点つまったメモ。\n①jdkが入ってなかったぽいので、install\n``\nyum install java-1.7.0-openjdk-devel\n``\n\n②crontab -eするとなんか起こられたので、以下実行。\n[root@vpsadmin ~]# touch ~/.bashrc\n[root@vpsadmin ~]# export VISUAL=vim\n[root@vpsadmin ~]# source ~/.bashrc\n\n\n以上。","body":"\u003Cp\u003E以下、記事にしたがって、Cloud Watchをカスタマイズしようと思った。\u003Cbr\u003E\n\u003Ca href=\"http://thinking.ne.jp/2013/01/aws-cloudwatch-ec2/\" title=\"http://thinking.ne.jp/2013/01/aws-cloudwatch-ec2/\" target=\"_blank\"\u003Ehttp://thinking.ne.jp/2013/01/aws-cloudwatch-ec2/\u003C/a\u003E\u003C/p\u003E\n\u003Cp\u003Eら、２点つまったメモ。\u003Cbr\u003E\n①jdkが入ってなかったぽいので、install\u003Cbr\u003E\n\u003Ccode\u003E\u003Cbr\u003E\nyum install java-1.7.0-openjdk-devel\u003Cbr\u003E\n\u003C/code\u003E\u003C/p\u003E\n\u003Cp\u003E②crontab -eするとなんか起こられたので、以下実行。\u003Cbr\u003E\n[root@vpsadmin ~]# touch ~/.bashrc\u003Cbr\u003E\n[root@vpsadmin ~]# export VISUAL=vim\u003Cbr\u003E\n[root@vpsadmin ~]# source ~/.bashrc\u003C/p\u003E\n\u003Cp\u003E以上。\u003C/p\u003E\n"},{"id":24626,"uuid":"1b09f4f5b8c760cb4c67","user":{"id":6406,"url_name":"soramugi","profile_image_url":"https://si0.twimg.com/profile_images/592608397/IMG_001009_normal.jpg"},"title":"Linuxのipアドレスのみを取得","created_at":"2013-08-14 11:42:40 +0900","updated_at":"2013-08-14 11:42:40 +0900","created_at_in_words":"13分前","updated_at_in_words":"13分前","tags":[{"name":"Linux","url_name":"linux","icon_url":"https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/ae420e8f134ac99c9f691b907029ae347d42c4fc/medium.jpg?1364838323","versions":[]}],"stock_count":0,"stock_users":[],"comment_count":0,"lgtm_count":0,"url":"http://qiita.com/soramugi/items/1b09f4f5b8c760cb4c67","gist_url":null,"tweet":true,"private":false,"created_at_as_seconds":1376448160,"raw_body":"    ifconfig eth0|grep inet|awk '{print $2}'|cut -d: -f2","body":"\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003Eifconfig eth0|grep inet|awk \u0026#39;{print $2}\u0026#39;|cut -d: -f2\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E"},{"id":24624,"uuid":"55390c60ba4a1d1fe5cd","user":{"id":12939,"url_name":"weed","profile_image_url":"https://secure.gravatar.com/avatar/7da1019ea35813b328f60f949a51ee2d?d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-user-420.png"},"title":"Node.js/Expressでのシンプルなファイルのアップロード","created_at":"2013-08-14 11:21:20 +0900","updated_at":"2013-08-14 11:36:29 +0900","created_at_in_words":"34分前","updated_at_in_words":"19分前","tags":[{"name":"Node.js","url_name":"node.js","icon_url":"https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/67adbe42be3974cc849b41d2e05ae8148bb46550/medium.jpg?1364838363","versions":["0.11.4"]},{"name":"Express","url_name":"express","icon_url":"/icons/medium/missing.png","versions":["3.3.5"]},{"name":"Jade","url_name":"jade","icon_url":"/icons/medium/missing.png","versions":[]},{"name":"CoffeeScript","url_name":"coffeescript","icon_url":"https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/e41b881d25c683db2ce913dba0d07b9695a55741/medium.jpg?1368788624","versions":["1.3.3"]}],"stock_count":0,"stock_users":[],"comment_count":0,"lgtm_count":0,"url":"http://qiita.com/weed/items/55390c60ba4a1d1fe5cd","gist_url":null,"tweet":false,"private":false,"created_at_as_seconds":1376446880,"raw_body":"基本的に以下のページと同じ内容です。\n\nNode.js/ExpressJSでのファイルのアップロード\nhttp://d.hatena.ne.jp/zebevogue/20120828/1346140796\n\nただし、何カ所か修正する必要がありました。\n\n###expressコマンド\n\n```\n$ express upload\n$ cd upload\n$ npm install\n$ mkdir uploads\n```\n\n流れとしては\n1. ```get '/'```で **routes/index.js#index** が呼ばれてフォームを表示し、\n2. ```post 'upload'```で **routes/upload.js#upload** が呼ばれてアップロードされたファイルを処理する\nという感じで良い。\n\nまず1.からやる。\n\n###app.jsを編集する\n\n下記のように編集する\n\n```js:app.js\nvar routes = {\n\tindex  : require('./routes/index'),\n};\n...\napp.get('/', routes.index.index);\n...\n```\n\n###routes/index.js\n\n個人的趣味でCoffeeScriptで書いた。```-b```オプションを付けた```coffee -bcw index.coffee```コマンドで変換するので、 **app.js** からでも中まで見える。というか、デフォルトそのまま。\n\n```coffeescript::index.coffee\nexports.index = (req, res) -\u003E\n  res.render 'index',{\n    title: 'Express'\n  }\n```\n\n```js:index.js\nexports.index = function(req, res) {\n  res.render('index', {\n    title: 'Express'\n  });\n};\n```\n\n参照する **index.jade** テンプレートにフォームを記述する。\n\n```jade:index.jade\nextends layout\n\nblock content\n  form(method=\"post\", enctype=\"multipart/form-data\", action=\"/upload\")\n    input(type=\"file\", name=\"thumbnail\")\n    input(type=\"submit\")\n```\n\nこれでフォームが見えるはず。\n\n![スクリーンショット 2013-08-14 11.15.18.png](https://qiita-image-store.s3.amazonaws.com/0/12939/1b9f1ac9-e909-62e2-2668-de3830071822.png)\n\n次に2.をやる\n\n###app.js\n\n```js:app.js\nvar routes = {\n\tindex  : require('./routes/index'),\n\tupload : require('./routes/upload')\n};\n...\n\napp.configure(function(){\n\t...\n\t//app.use(express.bodyParser());\n\tapp.use(express.bodyParser({uploadDir:'./uploads'}));\n\t...\n});\n\napp.get('/', routes.index.index);\napp.post('/upload', routes.upload.post);\n...\n```\n\n###routes/upload.js\n\n```coffeescript:upload.coffee\nfs = require 'fs'\nexports.post = (req, res) -\u003E\n  # 一時ファイルのパス\n  tmp_path = req.files.thumbnail.path\n  # public以下に置くパス\n  target_path = './uploads/' + req.files.thumbnail.name\n  # public以下に移動\n  fs.rename tmp_path, target_path, (err) -\u003E\n    if err then throw err\n    # 一時ファイルを削除\n    fs.unlink tmp_path, -\u003E\n      if err then throw err\n      res.send 'File uploaded to: ' + target_path + ' - ' + req.files.thumbnail.size + ' bytes'\n```\n\n```js:upload.js\nvar fs;\n\nfs = require('fs');\n\nexports.post = function(req, res) {\n  var target_path, tmp_path;\n  tmp_path = req.files.thumbnail.path;\n  target_path = './uploads/' + req.files.thumbnail.name;\n  fs.rename(tmp_path, target_path, function(err) {\n    if (err) {\n      throw err;\n    }\n    fs.unlink(tmp_path, function() {\n      if (err) {\n        throw err;\n      }\n      res.send('File uploaded to: ' + target_path + ' - ' + req.files.thumbnail.size + ' bytes');\n    });\n  });\n};\n```\n\nこれで以下のようにアップロードできるようになる。\n\n![スクリーンショット 2013-08-14 11.18.54.png](https://qiita-image-store.s3.amazonaws.com/0/12939/4b69bd93-f030-34c7-a346-11f977b078b7.png)\n\n-----\nブログやってます：[PAPA-tronix !](http://weed.cocolog-nifty.com/wzero3es/)\n","body":"\u003Cp\u003E基本的に以下のページと同じ内容です。\u003C/p\u003E\n\u003Cp\u003ENode.js/ExpressJSでのファイルのアップロード\u003Cbr\u003E\n\u003Ca href=\"http://d.hatena.ne.jp/zebevogue/20120828/1346140796\" title=\"http://d.hatena.ne.jp/zebevogue/20120828/1346140796\" target=\"_blank\"\u003Ehttp://d.hatena.ne.jp/zebevogue/20120828/1346140796\u003C/a\u003E\u003C/p\u003E\n\u003Cp\u003Eただし、何カ所か修正する必要がありました。\u003C/p\u003E\n\u003Ch3\u003E\n        \u003Cspan id=\"3-1\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#3-1\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003Eexpressコマンド\n      \u003C/h3\u003E\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E$ express upload\n$ cd upload\n$ npm install\n$ mkdir uploads\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cp\u003E流れとしては\u003Cbr\u003E\n1. \u003Ccode\u003Eget \u0026#39;/\u0026#39;\u003C/code\u003Eで \u003Cstrong\u003Eroutes/index.js#index\u003C/strong\u003E が呼ばれてフォームを表示し、\u003Cbr\u003E\n2. \u003Ccode\u003Epost \u0026#39;upload\u0026#39;\u003C/code\u003Eで \u003Cstrong\u003Eroutes/upload.js#upload\u003C/strong\u003E が呼ばれてアップロードされたファイルを処理する\u003Cbr\u003E\nという感じで良い。\u003C/p\u003E\n\u003Cp\u003Eまず1.からやる。\u003C/p\u003E\n\u003Ch3\u003E\n        \u003Cspan id=\"3-2\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#3-2\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003Eapp.jsを編集する\n      \u003C/h3\u003E\u003Cp\u003E下記のように編集する\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"code-lang\"\u003E\u003Cspan class=\"bold\"\u003Eapp.js\u003C/span\u003E\u003C/div\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Cspan class=\"kd\"\u003Evar\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eroutes\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n    \u003Cspan class=\"nx\"\u003Eindex\u003C/span\u003E  \u003Cspan class=\"o\"\u003E:\u003C/span\u003E \u003Cspan class=\"nx\"\u003Erequire\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;./routes/index\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E),\u003C/span\u003E\n\u003Cspan class=\"p\"\u003E};\u003C/span\u003E\n\u003Cspan class=\"p\"\u003E...\u003C/span\u003E\n\u003Cspan class=\"nx\"\u003Eapp\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eget\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;/\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eroutes\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eindex\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eindex\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n\u003Cspan class=\"p\"\u003E...\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Ch3\u003E\n        \u003Cspan id=\"3-3\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#3-3\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003Eroutes/index.js\n      \u003C/h3\u003E\u003Cp\u003E個人的趣味でCoffeeScriptで書いた。\u003Ccode\u003E-b\u003C/code\u003Eオプションを付けた\u003Ccode\u003Ecoffee -bcw index.coffee\u003C/code\u003Eコマンドで変換するので、 \u003Cstrong\u003Eapp.js\u003C/strong\u003E からでも中まで見える。というか、デフォルトそのまま。\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"code-lang\"\u003E\u003Cspan class=\"bold\"\u003E:index.coffee\u003C/span\u003E\u003C/div\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Cspan class=\"nv\"\u003Eexports.index = \u003C/span\u003E\u003Cspan class=\"nf\"\u003E(req, res) -\u0026gt;\u003C/span\u003E\n  \u003Cspan class=\"nx\"\u003Eres\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Erender\u003C/span\u003E \u003Cspan class=\"s\"\u003E\u0026#39;index\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,{\u003C/span\u003E\n    \u003Cspan class=\"nv\"\u003Etitle: \u003C/span\u003E\u003Cspan class=\"s\"\u003E\u0026#39;Express\u0026#39;\u003C/span\u003E\n  \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"code-lang\"\u003E\u003Cspan class=\"bold\"\u003Eindex.js\u003C/span\u003E\u003C/div\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Cspan class=\"nx\"\u003Eexports\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eindex\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"kd\"\u003Efunction\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nx\"\u003Ereq\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eres\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n  \u003Cspan class=\"nx\"\u003Eres\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Erender\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;index\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n    \u003Cspan class=\"nx\"\u003Etitle\u003C/span\u003E\u003Cspan class=\"o\"\u003E:\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;Express\u0026#39;\u003C/span\u003E\n  \u003Cspan class=\"p\"\u003E});\u003C/span\u003E\n\u003Cspan class=\"p\"\u003E};\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cp\u003E参照する \u003Cstrong\u003Eindex.jade\u003C/strong\u003E テンプレートにフォームを記述する。\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"code-lang\"\u003E\u003Cspan class=\"bold\"\u003Eindex.jade\u003C/span\u003E\u003C/div\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Cspan class=\"nt\"\u003Eextends\u003C/span\u003E layout\n\n\u003Cspan class=\"nt\"\u003Eblock\u003C/span\u003E content\n  \u003Cspan class=\"nt\"\u003Eform\u003C/span\u003E(\u003Cspan class=\"na\"\u003Emethod=\u003C/span\u003E\u003Cspan class=\"s\"\u003E\u0026quot;post\u0026quot;\u003C/span\u003E\u003Cspan class=\"err\"\u003E,\u003C/span\u003E \u003Cspan class=\"na\"\u003Eenctype=\u003C/span\u003E\u003Cspan class=\"s\"\u003E\u0026quot;multipart/form-data\u0026quot;\u003C/span\u003E\u003Cspan class=\"err\"\u003E,\u003C/span\u003E \u003Cspan class=\"na\"\u003Eaction=\u003C/span\u003E\u003Cspan class=\"s\"\u003E\u0026quot;/upload\u0026quot;\u003C/span\u003E)\n    \u003Cspan class=\"nt\"\u003Einput\u003C/span\u003E(\u003Cspan class=\"na\"\u003Etype=\u003C/span\u003E\u003Cspan class=\"s\"\u003E\u0026quot;file\u0026quot;\u003C/span\u003E\u003Cspan class=\"err\"\u003E,\u003C/span\u003E \u003Cspan class=\"na\"\u003Ename=\u003C/span\u003E\u003Cspan class=\"s\"\u003E\u0026quot;thumbnail\u0026quot;\u003C/span\u003E)\n    \u003Cspan class=\"nt\"\u003Einput\u003C/span\u003E(\u003Cspan class=\"na\"\u003Etype=\u003C/span\u003E\u003Cspan class=\"s\"\u003E\u0026quot;submit\u0026quot;\u003C/span\u003E)\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cp\u003Eこれでフォームが見えるはず。\u003C/p\u003E\n\u003Cp\u003E\u003Cimg src=\"https://qiita-image-store.s3.amazonaws.com/0/12939/1b9f1ac9-e909-62e2-2668-de3830071822.png\" alt=\"スクリーンショット 2013-08-14 11.15.18.png\"\u003E\u003C/p\u003E\n\u003Cp\u003E次に2.をやる\u003C/p\u003E\n\u003Ch3\u003E\n        \u003Cspan id=\"3-4\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#3-4\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003Eapp.js\n      \u003C/h3\u003E\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"code-lang\"\u003E\u003Cspan class=\"bold\"\u003Eapp.js\u003C/span\u003E\u003C/div\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Cspan class=\"kd\"\u003Evar\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eroutes\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n    \u003Cspan class=\"nx\"\u003Eindex\u003C/span\u003E  \u003Cspan class=\"o\"\u003E:\u003C/span\u003E \u003Cspan class=\"nx\"\u003Erequire\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;./routes/index\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E),\u003C/span\u003E\n    \u003Cspan class=\"nx\"\u003Eupload\u003C/span\u003E \u003Cspan class=\"o\"\u003E:\u003C/span\u003E \u003Cspan class=\"nx\"\u003Erequire\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;./routes/upload\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\u003Cspan class=\"p\"\u003E};\u003C/span\u003E\n\u003Cspan class=\"p\"\u003E...\u003C/span\u003E\n\n\u003Cspan class=\"nx\"\u003Eapp\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Econfigure\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"kd\"\u003Efunction\u003C/span\u003E\u003Cspan class=\"p\"\u003E(){\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E...\u003C/span\u003E\n    \u003Cspan class=\"c1\"\u003E//app.use(express.bodyParser());\u003C/span\u003E\n    \u003Cspan class=\"nx\"\u003Eapp\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Euse\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eexpress\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003EbodyParser\u003C/span\u003E\u003Cspan class=\"p\"\u003E({\u003C/span\u003E\u003Cspan class=\"nx\"\u003EuploadDir\u003C/span\u003E\u003Cspan class=\"o\"\u003E:\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;./uploads\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E}));\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E...\u003C/span\u003E\n\u003Cspan class=\"p\"\u003E});\u003C/span\u003E\n\n\u003Cspan class=\"nx\"\u003Eapp\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eget\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;/\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eroutes\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eindex\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eindex\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n\u003Cspan class=\"nx\"\u003Eapp\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Epost\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;/upload\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eroutes\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eupload\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Epost\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n\u003Cspan class=\"p\"\u003E...\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Ch3\u003E\n        \u003Cspan id=\"3-5\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#3-5\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003Eroutes/upload.js\n      \u003C/h3\u003E\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"code-lang\"\u003E\u003Cspan class=\"bold\"\u003Eupload.coffee\u003C/span\u003E\u003C/div\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Cspan class=\"nv\"\u003Efs = \u003C/span\u003E\u003Cspan class=\"nx\"\u003Erequire\u003C/span\u003E \u003Cspan class=\"s\"\u003E\u0026#39;fs\u0026#39;\u003C/span\u003E\n\u003Cspan class=\"nv\"\u003Eexports.post = \u003C/span\u003E\u003Cspan class=\"nf\"\u003E(req, res) -\u0026gt;\u003C/span\u003E\n  \u003Cspan class=\"c1\"\u003E# 一時ファイルのパス\u003C/span\u003E\n  \u003Cspan class=\"nv\"\u003Etmp_path = \u003C/span\u003E\u003Cspan class=\"nx\"\u003Ereq\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Efiles\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Ethumbnail\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Epath\u003C/span\u003E\n  \u003Cspan class=\"c1\"\u003E# public以下に置くパス\u003C/span\u003E\n  \u003Cspan class=\"nv\"\u003Etarget_path = \u003C/span\u003E\u003Cspan class=\"s\"\u003E\u0026#39;./uploads/\u0026#39;\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"nx\"\u003Ereq\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Efiles\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Ethumbnail\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Ename\u003C/span\u003E\n  \u003Cspan class=\"c1\"\u003E# public以下に移動\u003C/span\u003E\n  \u003Cspan class=\"nx\"\u003Efs\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Erename\u003C/span\u003E \u003Cspan class=\"nx\"\u003Etmp_path\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nx\"\u003Etarget_path\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nf\"\u003E(err) -\u0026gt;\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eerr\u003C/span\u003E \u003Cspan class=\"k\"\u003Ethen\u003C/span\u003E \u003Cspan class=\"k\"\u003Ethrow\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eerr\u003C/span\u003E\n    \u003Cspan class=\"c1\"\u003E# 一時ファイルを削除\u003C/span\u003E\n    \u003Cspan class=\"nx\"\u003Efs\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eunlink\u003C/span\u003E \u003Cspan class=\"nx\"\u003Etmp_path\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nf\"\u003E-\u0026gt;\u003C/span\u003E\n      \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eerr\u003C/span\u003E \u003Cspan class=\"k\"\u003Ethen\u003C/span\u003E \u003Cspan class=\"k\"\u003Ethrow\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eerr\u003C/span\u003E\n      \u003Cspan class=\"nx\"\u003Eres\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Esend\u003C/span\u003E \u003Cspan class=\"s\"\u003E\u0026#39;File uploaded to: \u0026#39;\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"nx\"\u003Etarget_path\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"s\"\u003E\u0026#39; - \u0026#39;\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"nx\"\u003Ereq\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Efiles\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Ethumbnail\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Esize\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"s\"\u003E\u0026#39; bytes\u0026#39;\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"code-lang\"\u003E\u003Cspan class=\"bold\"\u003Eupload.js\u003C/span\u003E\u003C/div\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Cspan class=\"kd\"\u003Evar\u003C/span\u003E \u003Cspan class=\"nx\"\u003Efs\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n\n\u003Cspan class=\"nx\"\u003Efs\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nx\"\u003Erequire\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;fs\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n\n\u003Cspan class=\"nx\"\u003Eexports\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Epost\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"kd\"\u003Efunction\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nx\"\u003Ereq\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eres\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n  \u003Cspan class=\"kd\"\u003Evar\u003C/span\u003E \u003Cspan class=\"nx\"\u003Etarget_path\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nx\"\u003Etmp_path\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n  \u003Cspan class=\"nx\"\u003Etmp_path\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nx\"\u003Ereq\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Efiles\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Ethumbnail\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Epath\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n  \u003Cspan class=\"nx\"\u003Etarget_path\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;./uploads/\u0026#39;\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"nx\"\u003Ereq\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Efiles\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Ethumbnail\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Ename\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n  \u003Cspan class=\"nx\"\u003Efs\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Erename\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nx\"\u003Etmp_path\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nx\"\u003Etarget_path\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"kd\"\u003Efunction\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eerr\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eerr\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n      \u003Cspan class=\"k\"\u003Ethrow\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eerr\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n    \u003Cspan class=\"nx\"\u003Efs\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eunlink\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nx\"\u003Etmp_path\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"kd\"\u003Efunction\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n      \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eerr\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Ethrow\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eerr\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n      \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n      \u003Cspan class=\"nx\"\u003Eres\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Esend\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;File uploaded to: \u0026#39;\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"nx\"\u003Etarget_path\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39; - \u0026#39;\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"nx\"\u003Ereq\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Efiles\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Ethumbnail\u003C/span\u003E\u003Cspan class=\"p\"\u003E.\u003C/span\u003E\u003Cspan class=\"nx\"\u003Esize\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39; bytes\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E});\u003C/span\u003E\n  \u003Cspan class=\"p\"\u003E});\u003C/span\u003E\n\u003Cspan class=\"p\"\u003E};\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cp\u003Eこれで以下のようにアップロードできるようになる。\u003C/p\u003E\n\u003Cp\u003E\u003Cimg src=\"https://qiita-image-store.s3.amazonaws.com/0/12939/4b69bd93-f030-34c7-a346-11f977b078b7.png\" alt=\"スクリーンショット 2013-08-14 11.18.54.png\"\u003E\u003C/p\u003E\n\n\u003Chr\u003E\n\u003Cp\u003Eブログやってます：\u003Ca href=\"http://weed.cocolog-nifty.com/wzero3es/\" title=\"http://weed.cocolog-nifty.com/wzero3es/\" target=\"_blank\"\u003EPAPA-tronix !\u003C/a\u003E\u003C/p\u003E\n"},{"id":24619,"uuid":"ffb7d8eba3833f1e3cf6","user":{"id":27361,"url_name":"bounscale","profile_image_url":"https://secure.gravatar.com/avatar/84e756f6fd841631143905ac82f8b52c?d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-user-420.png"},"title":"zbxapi(Ruby)でZabbixから取得した結果をキャッシュする","created_at":"2013-08-14 11:05:26 +0900","updated_at":"2013-08-14 11:05:26 +0900","created_at_in_words":"1時間前","updated_at_in_words":"1時間前","tags":[{"name":"zabbix","url_name":"zabbix","icon_url":"/icons/medium/missing.png","versions":[]},{"name":"Ruby","url_name":"ruby","icon_url":"https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/9de6a11d330f5694820082438f88ccf4a1b289b2/medium.jpg?1364837630","versions":[]},{"name":"zbxapi","url_name":"zbxapi","icon_url":"/icons/medium/missing.png","versions":[]}],"stock_count":0,"stock_users":[],"comment_count":0,"lgtm_count":0,"url":"http://qiita.com/bounscale/items/ffb7d8eba3833f1e3cf6","gist_url":null,"tweet":false,"private":false,"created_at_as_seconds":1376445926,"raw_body":"zbxapi(Ruby)でZabbixから取得した結果をキャッシュする\n====\n\nはじめに\n----\n[Bounscale](https://github.com/bounscale/bounscale/)というオートスケールするHeroku Addonを作っています。\n\nBounscaleはオートスケーリングの実施をするバックエンド部分にオープンソースの監視ソフト[Zabbix](https://www.zabbix.org/)を利用しています。１サーバ当たりの集約率を上げるために、Zabbix自体への接続をできるだけ回避する方法を考案したので、下記に書いておきます。\n\n背景\n----\nZabbixは[ZabbixAPIというWebAPI](https://www.zabbix.com/documentation/2.0/manual/appendix/api/api)を備えています。Bounscaleでは、フロントエンドのRubyからZabbixAPIへの接続ライブラリには[zbxapi](http://trac.red-tux.net/wiki/zbx_api)というgemを利用しています。\nZabbix上のデータが多数溜まってくると、このZabbixAPIからのレスポンスが悪くなってきて、フロントエンドがもっさりしてきます。\n\nもちろんZabbix自体のチューニングを実施する事も重要ですが、ほとんど更新のないようなデータを、Rubyが繰り返しZabbixへリクエスト部分があったので、キャッシュ化することで不要なやりとりを回避しようと考えました。\n\nアイデア\n----\nZabbixAPIはHTTPのリクエスト/レスポンスをJSON形式でやり取りします。\nそこで、リクエストのJSONデータをキー、レスポンスをバリューとしたキーバリューストアを準備すれば、キャッシングに使えそうです。\nキーは一意であれば全データである必要はありませんので、SHAなどでハッシュ化した文字列を持たせておけば十分でしょう。\n\nバージョン\n----\nZabbix 2.0.3\nzbxapi 0.2.415\n\n実装方式\n----\nzbxapiライブラリのメソッドをRubyのオープンクラスとaliasでチェーン化して、間にキャッシュの機構をはさみます。キーバリューストアは今回のサンプルでは単にグローバルなハッシュテーブルとします。\n\nソース\n----\n下記のような感じで実装してみました。\n\n一応Thread.currentでスイッチのON/OFFを切り替えていてcache_enableブロックで囲まれている箇所でのみ有効となるようにしています。（Thread.currentはノンブロッキングだと崩壊しそうですが、今回はサンプルなので多めに見てください）\n\nまた、リクエストのJSONの中に全体の問い合わせの通番のような感じでカウントアップしていく値が含まれているので、そこは塗りつぶし（gsub）しています。\n\n````ruby\nrequire 'rubygems'\nrequire 'zbxapi'\nrequire 'openssl'\n\n# 簡易なキャッシュ用のクラス\nclass ZabbixCache\n  class \u003C\u003C self\n    @@cache = {}\n\n    def set(key, value)\n      @@cache[key] = value\n    end\n\n    def get(key)\n      @@cache[key]\n    end\n\n    def cache_enable\n      begin\n        Thread.current[:zabbix_cache_enable] = true\n        yield\n      ensure\n        Thread.current[:zabbix_cache_enable] = nil\n      end\n    end\n  end\nend\n\n# zbxapiから提供されるZabbixAPIクラスを再オープン\nclass ZabbixAPI\n  alias :do_request_orig :do_request\n  private\n  def do_request(json_obj,truncate_length=5000)\n    if defined? ZabbixCache\n      json_obj_key = OpenSSL::Digest::SHA1.hexdigest(json_obj.gsub(/\"id\":\\d*/, ''))\n      cache = ZabbixCache.get(json_obj_key)\n      result = nil\n      enable = Thread.current[:zabbix_cache_enable]\n      if cache \u0026\u0026 enable\n        puts 'CACHE HIT'\n        result = cache\n      else\n        result = do_request_orig(json_obj, truncate_length)\n        ZabbixCache.set(json_obj_key, result)\n      end\n      return result\n    else\n      return do_request_orig(json_obj, truncate_length)\n    end\n  end\nend\n\n# 実行\n\nputs \"####### login ######\"\nzabbix = ZabbixAPI.new('http://localhost/zabbix', :debug =\u003E 4)\nzabbix.login('admin', 'zabbix')\n\nputs \"####### request without cache ######\"\nresult = zabbix.user.get(:filter =\u003E {:alias =\u003E ['admin']}).first\np result\n\nputs \"####### request with cache ######\"\nZabbixCache.cache_enable do\n  cached_result = zabbix.user.get(:filter =\u003E {:alias =\u003E ['admin']}).first\n  p cached_result\nend\n````\n\n結果\n----\n結果は下記です。\n\n````\n####### login ######\nD4 ..././zbxapi.rb:do_request_orig:352 Sending: {\"method\":\"user.login\",\"auth\":null,\"params\":{\"password\":\"zabbix\",\"user\":\"admin\"},\"id\":0,\"jsonrpc\":\"2.0\"}\nD4 ..././zbxapi.rb:do_request_orig:354 Response Code: 200\nD4 ..././zbxapi.rb:do_request_orig:355 Response Body: {\"jsonrpc\":\"2.0\",\"result\":\"efbabb46f84d3c9f409392b575261156\",\"id\":0}\nD4 ..././zbxapi.rb:do_request_orig:352 Sending: {\"method\":\"APIInfo.version\",\"auth\":\"efbabb46f84d3c9f409392b575261156\",\"params\":{},\"id\":1,\"jsonrpc\":\"2.0\"}\nD4 ..././zbxapi.rb:do_request_orig:354 Response Code: 200\nD4 ..././zbxapi.rb:do_request_orig:355 Response Body: {\"jsonrpc\":\"2.0\",\"result\":\"1.4\",\"id\":1}\n####### request without cache ######\nD4 ..././zbxapi.rb:do_request_orig:352 Sending: {\"method\":\"user.get\",\"auth\":\"efbabb46f84d3c9f409392b575261156\",\"params\":{\"filter\":{\"alias\":[\"admin\"]}},\"id\":2,\"jsonrpc\":\"2.0\"}\nD4 ..././zbxapi.rb:do_request_orig:354 Response Code: 200\nD4 ..././zbxapi.rb:do_request_orig:355 Response Body: {\"jsonrpc\":\"2.0\",\"result\":[{\"userid\":\"1\"}],\"id\":2}\n{\"userid\"=\u003E\"1\"}\n####### request with cache ######\nCACHE HIT\n{\"userid\"=\u003E\"1\"}\n````\n\n下記の部分がZabbixAPIへのリクエスト処理です。\n\n````\nD4 ..././zbxapi.rb:do_request_orig:352 Sending: {\"method\":\"user.get\",\"auth\":\"efbabb46f84d3c9f409392b575261156\",\"params\":{\"filter\":{\"alias\":[\"admin\"]}},\"id\":2,\"jsonrpc\":\"2.0\"}\nD4 ..././zbxapi.rb:do_request_orig:354 Response Code: 200\nD4 ..././zbxapi.rb:do_request_orig:355 Response Body: {\"jsonrpc\":\"2.0\",\"result\":[{\"userid\":\"1\"}],\"id\":2}\n````\n\nキャッシュを効かせた状態では表示されていないので、見事にキャッシュされています。\n\n終わりに\n----\nキャッシュの機構の骨子は上記で作ることができました。\n\n次はどのタイミングでリフレッシュして最新のデータに同期するのかが問題となってきますが、これについてはアプリケーション毎にタイミングが異なるので、慎重に検討する必要があるでしょう。","body":"\u003Ch1\u003E\n        \u003Cspan id=\"1-1\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#1-1\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003Ezbxapi(Ruby)でZabbixから取得した結果をキャッシュする\n      \u003C/h1\u003E\u003Ch2\u003E\n        \u003Cspan id=\"2-1\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#2-1\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003Eはじめに\n      \u003C/h2\u003E\u003Cp\u003E\u003Ca href=\"https://github.com/bounscale/bounscale/\" title=\"https://github.com/bounscale/bounscale/\" target=\"_blank\"\u003EBounscale\u003C/a\u003EというオートスケールするHeroku Addonを作っています。\u003C/p\u003E\n\u003Cp\u003EBounscaleはオートスケーリングの実施をするバックエンド部分にオープンソースの監視ソフト\u003Ca href=\"https://www.zabbix.org/\" title=\"https://www.zabbix.org/\" target=\"_blank\"\u003EZabbix\u003C/a\u003Eを利用しています。１サーバ当たりの集約率を上げるために、Zabbix自体への接続をできるだけ回避する方法を考案したので、下記に書いておきます。\u003C/p\u003E\n\u003Ch2\u003E\n        \u003Cspan id=\"2-2\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#2-2\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003E背景\n      \u003C/h2\u003E\u003Cp\u003EZabbixは\u003Ca href=\"https://www.zabbix.com/documentation/2.0/manual/appendix/api/api\" title=\"https://www.zabbix.com/documentation/2.0/manual/appendix/api/api\" target=\"_blank\"\u003EZabbixAPIというWebAPI\u003C/a\u003Eを備えています。Bounscaleでは、フロントエンドのRubyからZabbixAPIへの接続ライブラリには\u003Ca href=\"http://trac.red-tux.net/wiki/zbx_api\" title=\"http://trac.red-tux.net/wiki/zbx_api\" target=\"_blank\"\u003Ezbxapi\u003C/a\u003Eというgemを利用しています。\u003Cbr\u003E\nZabbix上のデータが多数溜まってくると、このZabbixAPIからのレスポンスが悪くなってきて、フロントエンドがもっさりしてきます。\u003C/p\u003E\n\u003Cp\u003EもちろんZabbix自体のチューニングを実施する事も重要ですが、ほとんど更新のないようなデータを、Rubyが繰り返しZabbixへリクエスト部分があったので、キャッシュ化することで不要なやりとりを回避しようと考えました。\u003C/p\u003E\n\u003Ch2\u003E\n        \u003Cspan id=\"2-3\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#2-3\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003Eアイデア\n      \u003C/h2\u003E\u003Cp\u003EZabbixAPIはHTTPのリクエスト/レスポンスをJSON形式でやり取りします。\u003Cbr\u003E\nそこで、リクエストのJSONデータをキー、レスポンスをバリューとしたキーバリューストアを準備すれば、キャッシングに使えそうです。\u003Cbr\u003E\nキーは一意であれば全データである必要はありませんので、SHAなどでハッシュ化した文字列を持たせておけば十分でしょう。\u003C/p\u003E\n\u003Ch2\u003E\n        \u003Cspan id=\"2-4\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#2-4\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003Eバージョン\n      \u003C/h2\u003E\u003Cp\u003EZabbix 2.0.3\u003Cbr\u003E\nzbxapi 0.2.415\u003C/p\u003E\n\u003Ch2\u003E\n        \u003Cspan id=\"2-5\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#2-5\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003E実装方式\n      \u003C/h2\u003E\u003Cp\u003EzbxapiライブラリのメソッドをRubyのオープンクラスとaliasでチェーン化して、間にキャッシュの機構をはさみます。キーバリューストアは今回のサンプルでは単にグローバルなハッシュテーブルとします。\u003C/p\u003E\n\u003Ch2\u003E\n        \u003Cspan id=\"2-6\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#2-6\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003Eソース\n      \u003C/h2\u003E\u003Cp\u003E下記のような感じで実装してみました。\u003C/p\u003E\n\u003Cp\u003E一応Thread.currentでスイッチのON/OFFを切り替えていてcache_enableブロックで囲まれている箇所でのみ有効となるようにしています。（Thread.currentはノンブロッキングだと崩壊しそうですが、今回はサンプルなので多めに見てください）\u003C/p\u003E\n\u003Cp\u003Eまた、リクエストのJSONの中に全体の問い合わせの通番のような感じでカウントアップしていく値が含まれているので、そこは塗りつぶし（gsub）しています。\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Cspan class=\"nb\"\u003Erequire\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;rubygems\u0026#39;\u003C/span\u003E\n\u003Cspan class=\"nb\"\u003Erequire\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;zbxapi\u0026#39;\u003C/span\u003E\n\u003Cspan class=\"nb\"\u003Erequire\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;openssl\u0026#39;\u003C/span\u003E\n\n\u003Cspan class=\"c1\"\u003E# 簡易なキャッシュ用のクラス\u003C/span\u003E\n\u003Cspan class=\"k\"\u003Eclass\u003C/span\u003E \u003Cspan class=\"nc\"\u003EZabbixCache\u003C/span\u003E\n  \u003Cspan class=\"k\"\u003Eclass\u003C/span\u003E \u003Cspan class=\"o\"\u003E\u0026lt;\u0026lt;\u003C/span\u003E \u003Cspan class=\"nb\"\u003Eself\u003C/span\u003E\n    \u003Cspan class=\"vc\"\u003E@@cache\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"p\"\u003E{}\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Edef\u003C/span\u003E \u003Cspan class=\"nf\"\u003Eset\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ekey\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Evalue\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n      \u003Cspan class=\"vc\"\u003E@@cache\u003C/span\u003E\u003Cspan class=\"o\"\u003E[\u003C/span\u003E\u003Cspan class=\"n\"\u003Ekey\u003C/span\u003E\u003Cspan class=\"o\"\u003E]\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Evalue\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Eend\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Edef\u003C/span\u003E \u003Cspan class=\"nf\"\u003Eget\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ekey\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n      \u003Cspan class=\"vc\"\u003E@@cache\u003C/span\u003E\u003Cspan class=\"o\"\u003E[\u003C/span\u003E\u003Cspan class=\"n\"\u003Ekey\u003C/span\u003E\u003Cspan class=\"o\"\u003E]\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Eend\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Edef\u003C/span\u003E \u003Cspan class=\"nf\"\u003Ecache_enable\u003C/span\u003E\n      \u003Cspan class=\"k\"\u003Ebegin\u003C/span\u003E\n        \u003Cspan class=\"no\"\u003EThread\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Ecurrent\u003C/span\u003E\u003Cspan class=\"o\"\u003E[\u003C/span\u003E\u003Cspan class=\"ss\"\u003E:zabbix_cache_enable\u003C/span\u003E\u003Cspan class=\"o\"\u003E]\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"kp\"\u003Etrue\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Eyield\u003C/span\u003E\n      \u003Cspan class=\"k\"\u003Eensure\u003C/span\u003E\n        \u003Cspan class=\"no\"\u003EThread\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Ecurrent\u003C/span\u003E\u003Cspan class=\"o\"\u003E[\u003C/span\u003E\u003Cspan class=\"ss\"\u003E:zabbix_cache_enable\u003C/span\u003E\u003Cspan class=\"o\"\u003E]\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"kp\"\u003Enil\u003C/span\u003E\n      \u003Cspan class=\"k\"\u003Eend\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Eend\u003C/span\u003E\n  \u003Cspan class=\"k\"\u003Eend\u003C/span\u003E\n\u003Cspan class=\"k\"\u003Eend\u003C/span\u003E\n\n\u003Cspan class=\"c1\"\u003E# zbxapiから提供されるZabbixAPIクラスを再オープン\u003C/span\u003E\n\u003Cspan class=\"k\"\u003Eclass\u003C/span\u003E \u003Cspan class=\"nc\"\u003EZabbixAPI\u003C/span\u003E\n  \u003Cspan class=\"k\"\u003Ealias\u003C/span\u003E \u003Cspan class=\"ss\"\u003E:do_request_orig\u003C/span\u003E \u003Cspan class=\"ss\"\u003E:do_request\u003C/span\u003E\n  \u003Cspan class=\"kp\"\u003Eprivate\u003C/span\u003E\n  \u003Cspan class=\"k\"\u003Edef\u003C/span\u003E \u003Cspan class=\"nf\"\u003Edo_request\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ejson_obj\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E\u003Cspan class=\"n\"\u003Etruncate_length\u003C/span\u003E\u003Cspan class=\"o\"\u003E=\u003C/span\u003E\u003Cspan class=\"mi\"\u003E5000\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"n\"\u003Edefined?\u003C/span\u003E \u003Cspan class=\"no\"\u003EZabbixCache\u003C/span\u003E\n      \u003Cspan class=\"n\"\u003Ejson_obj_key\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"ss\"\u003EOpenSSL\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E\u003Cspan class=\"ss\"\u003E:Digest\u003C/span\u003E\u003Cspan class=\"o\"\u003E::\u003C/span\u003E\u003Cspan class=\"no\"\u003ESHA1\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Ehexdigest\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ejson_obj\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Egsub\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"sr\"\u003E/\u0026quot;id\u0026quot;:\\d*/\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E))\u003C/span\u003E\n      \u003Cspan class=\"n\"\u003Ecache\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"no\"\u003EZabbixCache\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eget\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ejson_obj_key\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n      \u003Cspan class=\"n\"\u003Eresult\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"kp\"\u003Enil\u003C/span\u003E\n      \u003Cspan class=\"n\"\u003Eenable\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"no\"\u003EThread\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Ecurrent\u003C/span\u003E\u003Cspan class=\"o\"\u003E[\u003C/span\u003E\u003Cspan class=\"ss\"\u003E:zabbix_cache_enable\u003C/span\u003E\u003Cspan class=\"o\"\u003E]\u003C/span\u003E\n      \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"n\"\u003Ecache\u003C/span\u003E \u003Cspan class=\"o\"\u003E\u0026amp;\u0026amp;\u003C/span\u003E \u003Cspan class=\"n\"\u003Eenable\u003C/span\u003E\n        \u003Cspan class=\"nb\"\u003Eputs\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;CACHE HIT\u0026#39;\u003C/span\u003E\n        \u003Cspan class=\"n\"\u003Eresult\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Ecache\u003C/span\u003E\n      \u003Cspan class=\"k\"\u003Eelse\u003C/span\u003E\n        \u003Cspan class=\"n\"\u003Eresult\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Edo_request_orig\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ejson_obj\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Etruncate_length\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n        \u003Cspan class=\"no\"\u003EZabbixCache\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eset\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ejson_obj_key\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Eresult\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n      \u003Cspan class=\"k\"\u003Eend\u003C/span\u003E\n      \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"n\"\u003Eresult\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Eelse\u003C/span\u003E\n      \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"n\"\u003Edo_request_orig\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ejson_obj\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Etruncate_length\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Eend\u003C/span\u003E\n  \u003Cspan class=\"k\"\u003Eend\u003C/span\u003E\n\u003Cspan class=\"k\"\u003Eend\u003C/span\u003E\n\n\u003Cspan class=\"c1\"\u003E# 実行\u003C/span\u003E\n\n\u003Cspan class=\"nb\"\u003Eputs\u003C/span\u003E \u003Cspan class=\"s2\"\u003E\u0026quot;####### login ######\u0026quot;\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Ezabbix\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"no\"\u003EZabbixAPI\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Enew\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;http://localhost/zabbix\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"ss\"\u003E:debug\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u0026gt;\u003C/span\u003E \u003Cspan class=\"mi\"\u003E4\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Ezabbix\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Elogin\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;admin\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;zabbix\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\n\u003Cspan class=\"nb\"\u003Eputs\u003C/span\u003E \u003Cspan class=\"s2\"\u003E\u0026quot;####### request without cache ######\u0026quot;\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Eresult\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Ezabbix\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Euser\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eget\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"ss\"\u003E:filter\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u0026gt;\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\u003Cspan class=\"ss\"\u003E:alias\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u0026gt;\u003C/span\u003E \u003Cspan class=\"o\"\u003E[\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;admin\u0026#39;\u003C/span\u003E\u003Cspan class=\"o\"\u003E]\u003C/span\u003E\u003Cspan class=\"p\"\u003E})\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Efirst\u003C/span\u003E\n\u003Cspan class=\"nb\"\u003Ep\u003C/span\u003E \u003Cspan class=\"n\"\u003Eresult\u003C/span\u003E\n\n\u003Cspan class=\"nb\"\u003Eputs\u003C/span\u003E \u003Cspan class=\"s2\"\u003E\u0026quot;####### request with cache ######\u0026quot;\u003C/span\u003E\n\u003Cspan class=\"no\"\u003EZabbixCache\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Ecache_enable\u003C/span\u003E \u003Cspan class=\"k\"\u003Edo\u003C/span\u003E\n  \u003Cspan class=\"n\"\u003Ecached_result\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Ezabbix\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Euser\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eget\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"ss\"\u003E:filter\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u0026gt;\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\u003Cspan class=\"ss\"\u003E:alias\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u0026gt;\u003C/span\u003E \u003Cspan class=\"o\"\u003E[\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;admin\u0026#39;\u003C/span\u003E\u003Cspan class=\"o\"\u003E]\u003C/span\u003E\u003Cspan class=\"p\"\u003E})\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Efirst\u003C/span\u003E\n  \u003Cspan class=\"nb\"\u003Ep\u003C/span\u003E \u003Cspan class=\"n\"\u003Ecached_result\u003C/span\u003E\n\u003Cspan class=\"k\"\u003Eend\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Ch2\u003E\n        \u003Cspan id=\"2-7\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#2-7\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003E結果\n      \u003C/h2\u003E\u003Cp\u003E結果は下記です。\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E####### login ######\nD4 ..././zbxapi.rb:do_request_orig:352 Sending: {\u0026quot;method\u0026quot;:\u0026quot;user.login\u0026quot;,\u0026quot;auth\u0026quot;:null,\u0026quot;params\u0026quot;:{\u0026quot;password\u0026quot;:\u0026quot;zabbix\u0026quot;,\u0026quot;user\u0026quot;:\u0026quot;admin\u0026quot;},\u0026quot;id\u0026quot;:0,\u0026quot;jsonrpc\u0026quot;:\u0026quot;2.0\u0026quot;}\nD4 ..././zbxapi.rb:do_request_orig:354 Response Code: 200\nD4 ..././zbxapi.rb:do_request_orig:355 Response Body: {\u0026quot;jsonrpc\u0026quot;:\u0026quot;2.0\u0026quot;,\u0026quot;result\u0026quot;:\u0026quot;efbabb46f84d3c9f409392b575261156\u0026quot;,\u0026quot;id\u0026quot;:0}\nD4 ..././zbxapi.rb:do_request_orig:352 Sending: {\u0026quot;method\u0026quot;:\u0026quot;APIInfo.version\u0026quot;,\u0026quot;auth\u0026quot;:\u0026quot;efbabb46f84d3c9f409392b575261156\u0026quot;,\u0026quot;params\u0026quot;:{},\u0026quot;id\u0026quot;:1,\u0026quot;jsonrpc\u0026quot;:\u0026quot;2.0\u0026quot;}\nD4 ..././zbxapi.rb:do_request_orig:354 Response Code: 200\nD4 ..././zbxapi.rb:do_request_orig:355 Response Body: {\u0026quot;jsonrpc\u0026quot;:\u0026quot;2.0\u0026quot;,\u0026quot;result\u0026quot;:\u0026quot;1.4\u0026quot;,\u0026quot;id\u0026quot;:1}\n####### request without cache ######\nD4 ..././zbxapi.rb:do_request_orig:352 Sending: {\u0026quot;method\u0026quot;:\u0026quot;user.get\u0026quot;,\u0026quot;auth\u0026quot;:\u0026quot;efbabb46f84d3c9f409392b575261156\u0026quot;,\u0026quot;params\u0026quot;:{\u0026quot;filter\u0026quot;:{\u0026quot;alias\u0026quot;:[\u0026quot;admin\u0026quot;]}},\u0026quot;id\u0026quot;:2,\u0026quot;jsonrpc\u0026quot;:\u0026quot;2.0\u0026quot;}\nD4 ..././zbxapi.rb:do_request_orig:354 Response Code: 200\nD4 ..././zbxapi.rb:do_request_orig:355 Response Body: {\u0026quot;jsonrpc\u0026quot;:\u0026quot;2.0\u0026quot;,\u0026quot;result\u0026quot;:[{\u0026quot;userid\u0026quot;:\u0026quot;1\u0026quot;}],\u0026quot;id\u0026quot;:2}\n{\u0026quot;userid\u0026quot;=\u0026gt;\u0026quot;1\u0026quot;}\n####### request with cache ######\nCACHE HIT\n{\u0026quot;userid\u0026quot;=\u0026gt;\u0026quot;1\u0026quot;}\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cp\u003E下記の部分がZabbixAPIへのリクエスト処理です。\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003ED4 ..././zbxapi.rb:do_request_orig:352 Sending: {\u0026quot;method\u0026quot;:\u0026quot;user.get\u0026quot;,\u0026quot;auth\u0026quot;:\u0026quot;efbabb46f84d3c9f409392b575261156\u0026quot;,\u0026quot;params\u0026quot;:{\u0026quot;filter\u0026quot;:{\u0026quot;alias\u0026quot;:[\u0026quot;admin\u0026quot;]}},\u0026quot;id\u0026quot;:2,\u0026quot;jsonrpc\u0026quot;:\u0026quot;2.0\u0026quot;}\nD4 ..././zbxapi.rb:do_request_orig:354 Response Code: 200\nD4 ..././zbxapi.rb:do_request_orig:355 Response Body: {\u0026quot;jsonrpc\u0026quot;:\u0026quot;2.0\u0026quot;,\u0026quot;result\u0026quot;:[{\u0026quot;userid\u0026quot;:\u0026quot;1\u0026quot;}],\u0026quot;id\u0026quot;:2}\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cp\u003Eキャッシュを効かせた状態では表示されていないので、見事にキャッシュされています。\u003C/p\u003E\n\u003Ch2\u003E\n        \u003Cspan id=\"2-8\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#2-8\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003E終わりに\n      \u003C/h2\u003E\u003Cp\u003Eキャッシュの機構の骨子は上記で作ることができました。\u003C/p\u003E\n\u003Cp\u003E次はどのタイミングでリフレッシュして最新のデータに同期するのかが問題となってきますが、これについてはアプリケーション毎にタイミングが異なるので、慎重に検討する必要があるでしょう。\u003C/p\u003E\n"},{"id":24618,"uuid":"a2b3233ba8eba2c2b30d","user":{"id":644,"url_name":"emegane","profile_image_url":"https://secure.gravatar.com/avatar/935270913bcb1b098691214d147b3ef3?d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-user-420.png"},"title":"CSVファイルをオブジェクト指向な感じで取り扱う方法","created_at":"2013-08-14 10:52:20 +0900","updated_at":"2013-08-14 10:52:20 +0900","created_at_in_words":"1時間前","updated_at_in_words":"1時間前","tags":[{"name":"PHP","url_name":"php","icon_url":"https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/aae632f19de784bc000b317b06ed2320f2582469/medium.jpg?1364837706","versions":["5.3"]}],"stock_count":0,"stock_users":[],"comment_count":0,"lgtm_count":0,"url":"http://qiita.com/emegane/items/a2b3233ba8eba2c2b30d","gist_url":null,"tweet":false,"private":false,"created_at_as_seconds":1376445140,"raw_body":"次のようなCSVファイルがあったとします。\n\n```\n日付,商品コード,数量\n2013-08-01,12345,1\n2013-08-01,23456,2\n2013-08-02,34567,1\n```\n\nこのファイルをPHPでいい感じに取り扱えるコードを書いてみました。\n\n```php:ImportCsv.php\n\u003C?php\nclass ImportCsv \n{\n    protected $date;\n    protected $code;\n    protected $quantity;\n\n    public function getDate()\n    {\n        return $this-\u003Edate;\n    }\n\n    public function setDate($date)\n    {\n        $this-\u003Edate = $date;\n    }\n\n    public function getCode()\n    {\n        return $this-\u003Ecode;\n    }\n\n    public function setCode($code)\n    {\n        $this-\u003Ecode = $code;\n    }\n\n    public function getQuantity()\n    {\n        return $this-\u003Equantity;\n    }\n\n    public function setQuantity($quantity)\n    {\n        $this-\u003Equantity = $quantity;\n    }\n\n    public function getLine()\n    {\n        $ret = array();\n\n        foreach (self::getSupportedColumns() as $columnName) {\n            $ret[] = !is_null($this-\u003E$columnName) ? $this-\u003E$columnName : '';\n        }\n\n        return self::convertArrayToCsv($ret);\n    }\n\n    public function setLine($line, $layout = null)\n    {\n        $columns = self::getSupportedColumns();\n\n        if (is_null($layout)) {\n            $layout = self::getHeader();\n        }\n\n        if (count($line) !== count($layout)) {\n            throw new \\InvalidArgumentException('Invalid CSV layout is given');\n        }\n\n        foreach ($layout as $key =\u003E $column) {\n            if (array_key_exists($column, $columns)) {\n                $property = $columns[$column];\n                $this-\u003E$property = trim($line[$key]);\n            }\n        }\n    }\n\n    public static function getHeader()\n    {\n        return self::convertArrayToCsv(array_keys(self::getSupportedColumns()));\n    }\n\n    public static function getSupportedColumns()\n    {\n        return array(\n                '日付' =\u003E 'date',\n                '商品コード' =\u003E 'code',\n                '数量' =\u003E 'quantity'\n        );\n    }\n\n    protected static function convertArrayToCsv(array $datas)\n    {\n        $delimiter = ',';\n\n        $csv = array();\n        foreach ($datas as $data) {\n            $csv[] = '\"' . str_replace('\"', '\"\"', $data) . '\"';\n        }\n\n        return implode($delimiter, $csv);\n    }\n}\n```\n\nで、読み込むときは\n\n```php:AwesomeAction.php\n\u003C?php\n    // CSVファイルをUTF-8に変換し、テンポラリファイルに展開\n    $buffer = preg_replace(\"/\\r\\n|\\r|\\n/\", \"\\n\", mb_convert_encoding(file_get_contents($path), 'utf-8', 'SJIS-win'));\n    $fp = tmpfile();\n    fwrite($fp, $buffer);\n    rewind($fp);\n\n    // CSVファイルを読み込み\n    $header = fgetcsv($fp);\n\n    while ($line = fgetcsv($fp)) {\n        $csv = new ImportCsv();\n        $csv-\u003EsetLine($line, $header);\n\n        $ret[] = $csv;\n    }\n\n    fclose($fp);\n\n    // 取り込んだデータを利用\n    foreach ($ret as $row) {\n        var_dump($row-\u003EgetDate());\n        var_dump($row-\u003EgetCode());\n        var_dump($row-\u003EgetQuantity());\n    }\n```\n\nで、書き込むときは\n\n```php:AwesomeAction.php\n \u003C?php\n   $fp = fopen($path, 'wb');\n\n    // ヘッダを書き込む\n    fwrite($fp, ImportCsv::getHeader() . \"\\r\\n\");\n\n    // データを書き込む\n    fwrite($fp, $csv-\u003EgetLine() . \"\\r\\n\");\n```","body":"\u003Cp\u003E次のようなCSVファイルがあったとします。\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E日付,商品コード,数量\n2013-08-01,12345,1\n2013-08-01,23456,2\n2013-08-02,34567,1\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cp\u003EこのファイルをPHPでいい感じに取り扱えるコードを書いてみました。\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"code-lang\"\u003E\u003Cspan class=\"bold\"\u003EImportCsv.php\u003C/span\u003E\u003C/div\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Cspan class=\"cp\"\u003E\u0026lt;?php\u003C/span\u003E\n\u003Cspan class=\"k\"\u003Eclass\u003C/span\u003E \u003Cspan class=\"nc\"\u003EImportCsv\u003C/span\u003E \n\u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Eprotected\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$date\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Eprotected\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$code\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Eprotected\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$quantity\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"k\"\u003Efunction\u003C/span\u003E \u003Cspan class=\"nf\"\u003EgetDate\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$this\u003C/span\u003E\u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E\u003Cspan class=\"na\"\u003Edate\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"k\"\u003Efunction\u003C/span\u003E \u003Cspan class=\"nf\"\u003EsetDate\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$date\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"nv\"\u003E$this\u003C/span\u003E\u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E\u003Cspan class=\"na\"\u003Edate\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$date\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"k\"\u003Efunction\u003C/span\u003E \u003Cspan class=\"nf\"\u003EgetCode\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$this\u003C/span\u003E\u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E\u003Cspan class=\"na\"\u003Ecode\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"k\"\u003Efunction\u003C/span\u003E \u003Cspan class=\"nf\"\u003EsetCode\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$code\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"nv\"\u003E$this\u003C/span\u003E\u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E\u003Cspan class=\"na\"\u003Ecode\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$code\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"k\"\u003Efunction\u003C/span\u003E \u003Cspan class=\"nf\"\u003EgetQuantity\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$this\u003C/span\u003E\u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E\u003Cspan class=\"na\"\u003Equantity\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"k\"\u003Efunction\u003C/span\u003E \u003Cspan class=\"nf\"\u003EsetQuantity\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$quantity\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"nv\"\u003E$this\u003C/span\u003E\u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E\u003Cspan class=\"na\"\u003Equantity\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$quantity\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"k\"\u003Efunction\u003C/span\u003E \u003Cspan class=\"nf\"\u003EgetLine\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"nv\"\u003E$ret\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Earray\u003C/span\u003E\u003Cspan class=\"p\"\u003E();\u003C/span\u003E\n\n        \u003Cspan class=\"k\"\u003Eforeach\u003C/span\u003E \u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E::\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetSupportedColumns\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E \u003Cspan class=\"k\"\u003Eas\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$columnName\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n            \u003Cspan class=\"nv\"\u003E$ret\u003C/span\u003E\u003Cspan class=\"p\"\u003E[]\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"o\"\u003E!\u003C/span\u003E\u003Cspan class=\"nb\"\u003Eis_null\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$this\u003C/span\u003E\u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$columnName\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"o\"\u003E?\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$this\u003C/span\u003E\u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$columnName\u003C/span\u003E \u003Cspan class=\"o\"\u003E:\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n        \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n        \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E::\u003C/span\u003E\u003Cspan class=\"na\"\u003EconvertArrayToCsv\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$ret\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"k\"\u003Efunction\u003C/span\u003E \u003Cspan class=\"nf\"\u003EsetLine\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$line\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$layout\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Enull\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"nv\"\u003E$columns\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E::\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetSupportedColumns\u003C/span\u003E\u003Cspan class=\"p\"\u003E();\u003C/span\u003E\n\n        \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nb\"\u003Eis_null\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$layout\u003C/span\u003E\u003Cspan class=\"p\"\u003E))\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n            \u003Cspan class=\"nv\"\u003E$layout\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E::\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetHeader\u003C/span\u003E\u003Cspan class=\"p\"\u003E();\u003C/span\u003E\n        \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n        \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nb\"\u003Ecount\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$line\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"o\"\u003E!==\u003C/span\u003E \u003Cspan class=\"nb\"\u003Ecount\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$layout\u003C/span\u003E\u003Cspan class=\"p\"\u003E))\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n            \u003Cspan class=\"k\"\u003Ethrow\u003C/span\u003E \u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"nx\"\u003E\\InvalidArgumentException\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;Invalid CSV layout is given\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n        \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n        \u003Cspan class=\"k\"\u003Eforeach\u003C/span\u003E \u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$layout\u003C/span\u003E \u003Cspan class=\"k\"\u003Eas\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$key\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u0026gt;\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$column\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n            \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nb\"\u003Earray_key_exists\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$column\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$columns\u003C/span\u003E\u003Cspan class=\"p\"\u003E))\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n                \u003Cspan class=\"nv\"\u003E$property\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$columns\u003C/span\u003E\u003Cspan class=\"p\"\u003E[\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$column\u003C/span\u003E\u003Cspan class=\"p\"\u003E];\u003C/span\u003E\n                \u003Cspan class=\"nv\"\u003E$this\u003C/span\u003E\u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$property\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nx\"\u003Etrim\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$line\u003C/span\u003E\u003Cspan class=\"p\"\u003E[\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$key\u003C/span\u003E\u003Cspan class=\"p\"\u003E]);\u003C/span\u003E\n            \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n        \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"k\"\u003Estatic\u003C/span\u003E \u003Cspan class=\"k\"\u003Efunction\u003C/span\u003E \u003Cspan class=\"nf\"\u003EgetHeader\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"nx\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E::\u003C/span\u003E\u003Cspan class=\"na\"\u003EconvertArrayToCsv\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nb\"\u003Earray_keys\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nx\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E::\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetSupportedColumns\u003C/span\u003E\u003Cspan class=\"p\"\u003E()));\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"k\"\u003Estatic\u003C/span\u003E \u003Cspan class=\"k\"\u003Efunction\u003C/span\u003E \u003Cspan class=\"nf\"\u003EgetSupportedColumns\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"k\"\u003Earray\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\n                \u003Cspan class=\"s1\"\u003E\u0026#39;日付\u0026#39;\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u0026gt;\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;date\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E\n                \u003Cspan class=\"s1\"\u003E\u0026#39;商品コード\u0026#39;\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u0026gt;\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;code\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E\n                \u003Cspan class=\"s1\"\u003E\u0026#39;数量\u0026#39;\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u0026gt;\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;quantity\u0026#39;\u003C/span\u003E\n        \u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Eprotected\u003C/span\u003E \u003Cspan class=\"k\"\u003Estatic\u003C/span\u003E \u003Cspan class=\"k\"\u003Efunction\u003C/span\u003E \u003Cspan class=\"nf\"\u003EconvertArrayToCsv\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"k\"\u003Earray\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$datas\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"nv\"\u003E$delimiter\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;,\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n\n        \u003Cspan class=\"nv\"\u003E$csv\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Earray\u003C/span\u003E\u003Cspan class=\"p\"\u003E();\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Eforeach\u003C/span\u003E \u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$datas\u003C/span\u003E \u003Cspan class=\"k\"\u003Eas\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$data\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n            \u003Cspan class=\"nv\"\u003E$csv\u003C/span\u003E\u003Cspan class=\"p\"\u003E[]\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;\u0026quot;\u0026#39;\u003C/span\u003E \u003Cspan class=\"o\"\u003E.\u003C/span\u003E \u003Cspan class=\"nb\"\u003Estr_replace\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;\u0026quot;\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;\u0026quot;\u0026quot;\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$data\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"o\"\u003E.\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;\u0026quot;\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n        \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n        \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"nb\"\u003Eimplode\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$delimiter\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$csv\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cp\u003Eで、読み込むときは\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"code-lang\"\u003E\u003Cspan class=\"bold\"\u003EAwesomeAction.php\u003C/span\u003E\u003C/div\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Cspan class=\"cp\"\u003E\u0026lt;?php\u003C/span\u003E\n    \u003Cspan class=\"c1\"\u003E// CSVファイルをUTF-8に変換し、テンポラリファイルに展開\u003C/span\u003E\n    \u003Cspan class=\"nv\"\u003E$buffer\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nb\"\u003Epreg_replace\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s2\"\u003E\u0026quot;/\u003C/span\u003E\u003Cspan class=\"se\"\u003E\\r\\n\u003C/span\u003E\u003Cspan class=\"s2\"\u003E|\u003C/span\u003E\u003Cspan class=\"se\"\u003E\\r\u003C/span\u003E\u003Cspan class=\"s2\"\u003E|\u003C/span\u003E\u003Cspan class=\"se\"\u003E\\n\u003C/span\u003E\u003Cspan class=\"s2\"\u003E/\u0026quot;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"s2\"\u003E\u0026quot;\u003C/span\u003E\u003Cspan class=\"se\"\u003E\\n\u003C/span\u003E\u003Cspan class=\"s2\"\u003E\u0026quot;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nb\"\u003Emb_convert_encoding\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nb\"\u003Efile_get_contents\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$path\u003C/span\u003E\u003Cspan class=\"p\"\u003E),\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;utf-8\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;SJIS-win\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E));\u003C/span\u003E\n    \u003Cspan class=\"nv\"\u003E$fp\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nb\"\u003Etmpfile\u003C/span\u003E\u003Cspan class=\"p\"\u003E();\u003C/span\u003E\n    \u003Cspan class=\"nb\"\u003Efwrite\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$fp\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$buffer\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n    \u003Cspan class=\"nb\"\u003Erewind\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$fp\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n\n    \u003Cspan class=\"c1\"\u003E// CSVファイルを読み込み\u003C/span\u003E\n    \u003Cspan class=\"nv\"\u003E$header\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nb\"\u003Efgetcsv\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$fp\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Ewhile\u003C/span\u003E \u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$line\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nb\"\u003Efgetcsv\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$fp\u003C/span\u003E\u003Cspan class=\"p\"\u003E))\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"nv\"\u003E$csv\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"nx\"\u003EImportCsv\u003C/span\u003E\u003Cspan class=\"p\"\u003E();\u003C/span\u003E\n        \u003Cspan class=\"nv\"\u003E$csv\u003C/span\u003E\u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E\u003Cspan class=\"na\"\u003EsetLine\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$line\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$header\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n\n        \u003Cspan class=\"nv\"\u003E$ret\u003C/span\u003E\u003Cspan class=\"p\"\u003E[]\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$csv\u003C/span\u003E\u003Cspan class=\"p\"\u003E;\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"nb\"\u003Efclose\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$fp\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n\n    \u003Cspan class=\"c1\"\u003E// 取り込んだデータを利用\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Eforeach\u003C/span\u003E \u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$ret\u003C/span\u003E \u003Cspan class=\"k\"\u003Eas\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$row\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"nb\"\u003Evar_dump\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$row\u003C/span\u003E\u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetDate\u003C/span\u003E\u003Cspan class=\"p\"\u003E());\u003C/span\u003E\n        \u003Cspan class=\"nb\"\u003Evar_dump\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$row\u003C/span\u003E\u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetCode\u003C/span\u003E\u003Cspan class=\"p\"\u003E());\u003C/span\u003E\n        \u003Cspan class=\"nb\"\u003Evar_dump\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$row\u003C/span\u003E\u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetQuantity\u003C/span\u003E\u003Cspan class=\"p\"\u003E());\u003C/span\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cp\u003Eで、書き込むときは\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"code-lang\"\u003E\u003Cspan class=\"bold\"\u003EAwesomeAction.php\u003C/span\u003E\u003C/div\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Cspan class=\"x\"\u003E \u003C/span\u003E\u003Cspan class=\"cp\"\u003E\u0026lt;?php\u003C/span\u003E\n   \u003Cspan class=\"nv\"\u003E$fp\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nb\"\u003Efopen\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$path\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;wb\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n\n    \u003Cspan class=\"c1\"\u003E// ヘッダを書き込む\u003C/span\u003E\n    \u003Cspan class=\"nb\"\u003Efwrite\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$fp\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nx\"\u003EImportCsv\u003C/span\u003E\u003Cspan class=\"o\"\u003E::\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetHeader\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E \u003Cspan class=\"o\"\u003E.\u003C/span\u003E \u003Cspan class=\"s2\"\u003E\u0026quot;\u003C/span\u003E\u003Cspan class=\"se\"\u003E\\r\\n\u003C/span\u003E\u003Cspan class=\"s2\"\u003E\u0026quot;\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n\n    \u003Cspan class=\"c1\"\u003E// データを書き込む\u003C/span\u003E\n    \u003Cspan class=\"nb\"\u003Efwrite\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"nv\"\u003E$fp\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"nv\"\u003E$csv\u003C/span\u003E\u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetLine\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E \u003Cspan class=\"o\"\u003E.\u003C/span\u003E \u003Cspan class=\"s2\"\u003E\u0026quot;\u003C/span\u003E\u003Cspan class=\"se\"\u003E\\r\\n\u003C/span\u003E\u003Cspan class=\"s2\"\u003E\u0026quot;\u003C/span\u003E\u003Cspan class=\"p\"\u003E);\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E"},{"id":24615,"uuid":"ab81aaa9329d745fb39f","user":{"id":6635,"url_name":"gongo@github","profile_image_url":"https://secure.gravatar.com/avatar/8519a654e3b51ef7dd19486a859ca91c?d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-140.png"},"title":"local のファイルを remote のブラウザで attach_file させるには","created_at":"2013-08-14 09:50:53 +0900","updated_at":"2013-08-14 09:50:53 +0900","created_at_in_words":"2時間前","updated_at_in_words":"2時間前","tags":[{"name":"Ruby","url_name":"ruby","icon_url":"https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/9de6a11d330f5694820082438f88ccf4a1b289b2/medium.jpg?1364837630","versions":[]},{"name":"Capybara","url_name":"capybara","icon_url":"/icons/medium/missing.png","versions":["2.1.0"]},{"name":"Selenium","url_name":"selenium","icon_url":"/icons/medium/missing.png","versions":[]},{"name":"WebDriver","url_name":"webdriver","icon_url":"/icons/medium/missing.png","versions":[]}],"stock_count":0,"stock_users":[],"comment_count":0,"lgtm_count":0,"url":"http://qiita.com/gongo@github/items/ab81aaa9329d745fb39f","gist_url":null,"tweet":false,"private":false,"created_at_as_seconds":1376441453,"raw_body":"## 環境想定\n\n`capybara` + `selenium-webdriver` でリモートマシンのブラウザを用いて実行しているとき\n\n※ 一応 `selenium-webdriver` は 2.34.0 で確認していますが、きっと前のバージョンでも使えると思います\n\n## 目的\n\n1. `Capybara::Node::Actions#attach_file`  でファイル添付を行いたいと考える\n\n    ```rb:\n    attach_file('import', '/home/gongo/fixtures/hoge.csv')\n    ```\n\n2. ブラウザがローカルで動いている分には問題ない。\n3. ブラウザがリモートで動いている場合に失敗する。なぜならリモートマシンに `/home/gongo/fixtures/hoge.csv` が **存在しないから**\n\n対応策としては、リモートマシンにも `/home/gongo/fixtures/hoge.csv` を配置しておけばいい。しかし……\n\n* 並列化のためリモート環境を大量に準備したい → 配置めんどい\n* もしリモート環境が Windows だったら → いちいちリモート環境に併せてパスの記述を変えたくない(`C:\\Users\\gongo\\fixtures/hoge.csv` みたいに)\n    * 実は `/path/to` 形式でもよしなにしてくれるんですかね……\n\n## 対策\n\n`Selenium::WebDriver::Driver#file_detector` を使います。\n\n```rb:\nCapybara.register_driver :remote_windows do |app|\n  # リモートマシンのブラウザを使う場合によくやる設定\n  caps = Selenium::WebDriver::Remote::Capabilities.internet_explorer\n  url  = \"http://#{host}:#{port}}/wd/hub/\"\n  opts = { desired_capabilities: caps, browser: :remote, url: url }\n  driver = Capybara::Selenium::Driver.new(app, opts)\n\n  # ここからが本題。driver を返す前に ↓ をしておく。\n  driver.browser.file_detector = lambda do |args|\n    str = args.first.to_s\n    str if File.exist? str\n  end\n\n  driver\nend\n```\n\nこの設定をすることで、 `attach_file` に指定したファイルが selenium webdriver の機能で **リモートマシンに転送** され、リモートマシンのブラウザからアクセスできるようになります。\n\n補足ですが、`lambda` の書き方的には\n\n1. まずは `attach_file` で指定されたファイルを **ローカルマシンで検索**\n2. ローカルになかった場合、今度は **リモートマシンで検索**\n3. どっちにも無かったら `raise Capybara::FileNotFound`\n\nとなります\n\n## 参考\n\n別記事でもまとめてあります。\n\nhttp://gongo.hatenablog.com/entry/2013/07/24/210526","body":"\u003Ch2\u003E\n        \u003Cspan id=\"2-1\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#2-1\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003E環境想定\n      \u003C/h2\u003E\u003Cp\u003E\u003Ccode\u003Ecapybara\u003C/code\u003E + \u003Ccode\u003Eselenium-webdriver\u003C/code\u003E でリモートマシンのブラウザを用いて実行しているとき\u003C/p\u003E\n\u003Cp\u003E※ 一応 \u003Ccode\u003Eselenium-webdriver\u003C/code\u003E は 2.34.0 で確認していますが、きっと前のバージョンでも使えると思います\u003C/p\u003E\n\u003Ch2\u003E\n        \u003Cspan id=\"2-2\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#2-2\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003E目的\n      \u003C/h2\u003E\n\u003Col\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003ECapybara::Node::Actions#attach_file\u003C/code\u003E  でファイル添付を行いたいと考える\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Cspan class=\"n\"\u003Eattach_file\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;import\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"s1\"\u003E\u0026#39;/home/gongo/fixtures/hoge.csv\u0026#39;\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003C/li\u003E\n\u003Cli\u003E\u003Cp\u003Eブラウザがローカルで動いている分には問題ない。\u003C/p\u003E\u003C/li\u003E\n\u003Cli\u003E\u003Cp\u003Eブラウザがリモートで動いている場合に失敗する。なぜならリモートマシンに \u003Ccode\u003E/home/gongo/fixtures/hoge.csv\u003C/code\u003E が \u003Cstrong\u003E存在しないから\u003C/strong\u003E\u003C/p\u003E\u003C/li\u003E\n\u003C/ol\u003E\n\u003Cp\u003E対応策としては、リモートマシンにも \u003Ccode\u003E/home/gongo/fixtures/hoge.csv\u003C/code\u003E を配置しておけばいい。しかし……\u003C/p\u003E\n\n\u003Cul\u003E\n\u003Cli\u003E並列化のためリモート環境を大量に準備したい → 配置めんどい\u003C/li\u003E\n\u003Cli\u003Eもしリモート環境が Windows だったら → いちいちリモート環境に併せてパスの記述を変えたくない(\u003Ccode\u003EC:\\Users\\gongo\\fixtures/hoge.csv\u003C/code\u003E みたいに)\n\n\u003Cul\u003E\n\u003Cli\u003E実は \u003Ccode\u003E/path/to\u003C/code\u003E 形式でもよしなにしてくれるんですかね……\u003C/li\u003E\n\u003C/ul\u003E\u003C/li\u003E\n\u003C/ul\u003E\n\u003Ch2\u003E\n        \u003Cspan id=\"2-3\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#2-3\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003E対策\n      \u003C/h2\u003E\u003Cp\u003E\u003Ccode\u003ESelenium::WebDriver::Driver#file_detector\u003C/code\u003E を使います。\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Cspan class=\"no\"\u003ECapybara\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eregister_driver\u003C/span\u003E \u003Cspan class=\"ss\"\u003E:remote_windows\u003C/span\u003E \u003Cspan class=\"k\"\u003Edo\u003C/span\u003E \u003Cspan class=\"o\"\u003E|\u003C/span\u003E\u003Cspan class=\"n\"\u003Eapp\u003C/span\u003E\u003Cspan class=\"o\"\u003E|\u003C/span\u003E\n  \u003Cspan class=\"c1\"\u003E# リモートマシンのブラウザを使う場合によくやる設定\u003C/span\u003E\n  \u003Cspan class=\"n\"\u003Ecaps\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"ss\"\u003ESelenium\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E\u003Cspan class=\"ss\"\u003E:WebDriver\u003C/span\u003E\u003Cspan class=\"o\"\u003E::\u003C/span\u003E\u003Cspan class=\"ss\"\u003ERemote\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E\u003Cspan class=\"ss\"\u003E:Capabilities\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Einternet_explorer\u003C/span\u003E\n  \u003Cspan class=\"n\"\u003Eurl\u003C/span\u003E  \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"s2\"\u003E\u0026quot;http://\u003C/span\u003E\u003Cspan class=\"si\"\u003E#{\u003C/span\u003E\u003Cspan class=\"n\"\u003Ehost\u003C/span\u003E\u003Cspan class=\"si\"\u003E}\u003C/span\u003E\u003Cspan class=\"s2\"\u003E:\u003C/span\u003E\u003Cspan class=\"si\"\u003E#{\u003C/span\u003E\u003Cspan class=\"n\"\u003Eport\u003C/span\u003E\u003Cspan class=\"si\"\u003E}\u003C/span\u003E\u003Cspan class=\"s2\"\u003E}/wd/hub/\u0026quot;\u003C/span\u003E\n  \u003Cspan class=\"n\"\u003Eopts\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"p\"\u003E{\u003C/span\u003E \u003Cspan class=\"n\"\u003Edesired_capabilities\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E \u003Cspan class=\"n\"\u003Ecaps\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"ss\"\u003Ebrowser\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E \u003Cspan class=\"ss\"\u003E:remote\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"ss\"\u003Eurl\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E \u003Cspan class=\"n\"\u003Eurl\u003C/span\u003E \u003Cspan class=\"p\"\u003E}\u003C/span\u003E\n  \u003Cspan class=\"n\"\u003Edriver\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"ss\"\u003ECapybara\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E\u003Cspan class=\"ss\"\u003E:Selenium\u003C/span\u003E\u003Cspan class=\"o\"\u003E::\u003C/span\u003E\u003Cspan class=\"no\"\u003EDriver\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Enew\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Eapp\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Eopts\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\n  \u003Cspan class=\"c1\"\u003E# ここからが本題。driver を返す前に ↓ をしておく。\u003C/span\u003E\n  \u003Cspan class=\"n\"\u003Edriver\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Ebrowser\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Efile_detector\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"nb\"\u003Elambda\u003C/span\u003E \u003Cspan class=\"k\"\u003Edo\u003C/span\u003E \u003Cspan class=\"o\"\u003E|\u003C/span\u003E\u003Cspan class=\"n\"\u003Eargs\u003C/span\u003E\u003Cspan class=\"o\"\u003E|\u003C/span\u003E\n    \u003Cspan class=\"n\"\u003Estr\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Eargs\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Efirst\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eto_s\u003C/span\u003E\n    \u003Cspan class=\"n\"\u003Estr\u003C/span\u003E \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"no\"\u003EFile\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eexist?\u003C/span\u003E \u003Cspan class=\"n\"\u003Estr\u003C/span\u003E\n  \u003Cspan class=\"k\"\u003Eend\u003C/span\u003E\n\n  \u003Cspan class=\"n\"\u003Edriver\u003C/span\u003E\n\u003Cspan class=\"k\"\u003Eend\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cp\u003Eこの設定をすることで、 \u003Ccode\u003Eattach_file\u003C/code\u003E に指定したファイルが selenium webdriver の機能で \u003Cstrong\u003Eリモートマシンに転送\u003C/strong\u003E され、リモートマシンのブラウザからアクセスできるようになります。\u003C/p\u003E\n\u003Cp\u003E補足ですが、\u003Ccode\u003Elambda\u003C/code\u003E の書き方的には\u003C/p\u003E\n\n\u003Col\u003E\n\u003Cli\u003Eまずは \u003Ccode\u003Eattach_file\u003C/code\u003E で指定されたファイルを \u003Cstrong\u003Eローカルマシンで検索\u003C/strong\u003E\u003C/li\u003E\n\u003Cli\u003Eローカルになかった場合、今度は \u003Cstrong\u003Eリモートマシンで検索\u003C/strong\u003E\u003C/li\u003E\n\u003Cli\u003Eどっちにも無かったら \u003Ccode\u003Eraise Capybara::FileNotFound\u003C/code\u003E\u003C/li\u003E\n\u003C/ol\u003E\n\u003Cp\u003Eとなります\u003C/p\u003E\n\u003Ch2\u003E\n        \u003Cspan id=\"2-4\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#2-4\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003E参考\n      \u003C/h2\u003E\u003Cp\u003E別記事でもまとめてあります。\u003C/p\u003E\n\u003Cp\u003E\u003Ca href=\"http://gongo.hatenablog.com/entry/2013/07/24/210526\" title=\"http://gongo.hatenablog.com/entry/2013/07/24/210526\" target=\"_blank\"\u003Ehttp://gongo.hatenablog.com/entry/2013/07/24/210526\u003C/a\u003E\u003C/p\u003E\n"},{"id":24614,"uuid":"690f3f4651f8f11e4ed3","user":{"id":8511,"url_name":"wnoguchi","profile_image_url":"https://si0.twimg.com/profile_images/2408676122/9ud6wrxc48p2xahpn9sf_normal.jpeg"},"title":"SSH接続で WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! って言われて接続を拒否られるとき","created_at":"2013-08-14 09:20:47 +0900","updated_at":"2013-08-14 09:24:10 +0900","created_at_in_words":"3時間前","updated_at_in_words":"3時間前","tags":[{"name":"Linux","url_name":"linux","icon_url":"https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/ae420e8f134ac99c9f691b907029ae347d42c4fc/medium.jpg?1364838323","versions":[]},{"name":"Vim","url_name":"vim","icon_url":"https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/798b52773f9b91f4ffbf5a2e9d1ed6c4f91c88f4/medium.jpg?1364837741","versions":[]},{"name":"SSH","url_name":"ssh","icon_url":"/icons/medium/missing.png","versions":[]},{"name":"sed","url_name":"sed","icon_url":"/icons/medium/missing.png","versions":[]}],"stock_count":1,"stock_users":["nilfigo"],"comment_count":1,"lgtm_count":0,"url":"http://qiita.com/wnoguchi/items/690f3f4651f8f11e4ed3","gist_url":null,"tweet":true,"private":false,"created_at_as_seconds":1376439647,"raw_body":"\n仮想マシンを何回も作りなおしていろんなホストにSSH接続していくと `known_hosts` にフィンガープリントのゴミが溜まっていくのですが、仮想マシンを全く同じ構成で作りなおして、同じIPで同じポートに接続しようとすると\n\n```\nlocalhost:~ noguchiwataru$ ssh root@192.168.0.114 -i ~/.ssh/openstack-default.key \n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\nIT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!\nSomeone could be eavesdropping on you right now (man-in-the-middle attack)!\nIt is also possible that a host key has just been changed.\nThe fingerprint for the RSA key sent by the remote host is\n0b:1d:3b:5e:b8:ba:ad:07:b5:71:7a:16:32:91:8d:2d.\nPlease contact your system administrator.\nAdd correct host key in /Users/noguchiwataru/.ssh/known_hosts to get rid of this message.\nOffending RSA key in /Users/noguchiwataru/.ssh/known_hosts:14\nRSA host key for 192.168.0.114 has changed and you have requested strict checking.\nHost key verification failed.\n```\n\nこんな感じで接続を拒否されます。\nなんだか大げさなメッセージが出て来ましたが、何もした覚えがないのに本番サイトでこれが出たらなりすましの可能性があるので **絶対接続しないほうがいいです。**\n\n今回のケースは実験目的なので特に問題はなくて、 `known_hosts` に記録された定義を削除して解決したいと思います。\nvimで開いて消すのもいいのですが、ファイルの内容が長くて探すの大変なので`sed` で消したいと思います。\n\n```\nsed -i -e '/0.114/d' ~/.ssh/known_hosts\n```\n\n`d` でマッチする行を削除するコマンドになります。\nこれで消えました。便利ですねー。\n\n```\nlocalhost:~ noguchiwataru$ ssh root@192.168.0.114 -i ~/.ssh/openstack-default.key \nThe authenticity of host '192.168.0.114 (192.168.0.114)' can't be established.\nRSA key fingerprint is 0b:1d:3b:5e:b8:ba:ad:07:b5:71:7a:16:32:91:8d:2d.\nAre you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added '192.168.0.114' (RSA) to the list of known hosts.\n\nwnoguchi Customized AMI Linux Image\nBase: CentOS 6.4 x64\n[root@sample ~]#\n```\n\n接続できた。\n","body":"\u003Cp\u003E仮想マシンを何回も作りなおしていろんなホストにSSH接続していくと \u003Ccode\u003Eknown_hosts\u003C/code\u003E にフィンガープリントのゴミが溜まっていくのですが、仮想マシンを全く同じ構成で作りなおして、同じIPで同じポートに接続しようとすると\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003Elocalhost:~ noguchiwataru$ ssh root@192.168.0.114 -i ~/.ssh/openstack-default.key \n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\nIT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!\nSomeone could be eavesdropping on you right now (man-in-the-middle attack)!\nIt is also possible that a host key has just been changed.\nThe fingerprint for the RSA key sent by the remote host is\n0b:1d:3b:5e:b8:ba:ad:07:b5:71:7a:16:32:91:8d:2d.\nPlease contact your system administrator.\nAdd correct host key in /Users/noguchiwataru/.ssh/known_hosts to get rid of this message.\nOffending RSA key in /Users/noguchiwataru/.ssh/known_hosts:14\nRSA host key for 192.168.0.114 has changed and you have requested strict checking.\nHost key verification failed.\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cp\u003Eこんな感じで接続を拒否されます。\u003Cbr\u003E\nなんだか大げさなメッセージが出て来ましたが、何もした覚えがないのに本番サイトでこれが出たらなりすましの可能性があるので \u003Cstrong\u003E絶対接続しないほうがいいです。\u003C/strong\u003E\u003C/p\u003E\n\u003Cp\u003E今回のケースは実験目的なので特に問題はなくて、 \u003Ccode\u003Eknown_hosts\u003C/code\u003E に記録された定義を削除して解決したいと思います。\u003Cbr\u003E\nvimで開いて消すのもいいのですが、ファイルの内容が長くて探すの大変なので\u003Ccode\u003Esed\u003C/code\u003E で消したいと思います。\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003Esed -i -e \u0026#39;/0.114/d\u0026#39; ~/.ssh/known_hosts\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cp\u003E\u003Ccode\u003Ed\u003C/code\u003E でマッチする行を削除するコマンドになります。\u003Cbr\u003E\nこれで消えました。便利ですねー。\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003Elocalhost:~ noguchiwataru$ ssh root@192.168.0.114 -i ~/.ssh/openstack-default.key \nThe authenticity of host \u0026#39;192.168.0.114 (192.168.0.114)\u0026#39; can\u0026#39;t be established.\nRSA key fingerprint is 0b:1d:3b:5e:b8:ba:ad:07:b5:71:7a:16:32:91:8d:2d.\nAre you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added \u0026#39;192.168.0.114\u0026#39; (RSA) to the list of known hosts.\n\nwnoguchi Customized AMI Linux Image\nBase: CentOS 6.4 x64\n[root@sample ~]#\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cp\u003E接続できた。\u003C/p\u003E\n"},{"id":24613,"uuid":"2876b632042b628dbafe","user":{"id":4140,"url_name":"toyoshi","profile_image_url":"https://secure.gravatar.com/avatar/8198db85e0df5e90daa3b4ccdb80ae80?d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-140.png"},"title":"LibreOffice”を最後に開いたとき、ウインドウの再開中にアプリケーションが突然終了しました。もう一度ウインドウを再開しますか？ が消えない","created_at":"2013-08-14 09:07:43 +0900","updated_at":"2013-08-14 09:07:43 +0900","created_at_in_words":"3時間前","updated_at_in_words":"3時間前","tags":[{"name":"openoffice","url_name":"openoffice","icon_url":"/icons/medium/missing.png","versions":[]},{"name":"libreoffice","url_name":"libreoffice","icon_url":"/icons/medium/missing.png","versions":[]}],"stock_count":0,"stock_users":[],"comment_count":0,"lgtm_count":0,"url":"http://qiita.com/toyoshi/items/2876b632042b628dbafe","gist_url":null,"tweet":true,"private":false,"created_at_as_seconds":1376438863,"raw_body":"\nMacの場合の解決策。\n要するに状態を保持している一時ファイルが駄目になっているので、それを直接消してやればいい\n\n + LibreOfficeを終了（強制終了）しておく \n + Finderでライブラリを開く （Finderの移動メニューを押して、Optionキーをおすとでてくる）\n + `Saved Application State` というディレクトリの `org.libreoffice.script.savedState`というディレクトリを開く\n + 中のファイルを全部消す（多分全部消さなくてもいいけど、不明）\n\nOpenOfficeでもディレクトリ名などが違うだけで多分同じ。\n","body":"\u003Cp\u003EMacの場合の解決策。\u003Cbr\u003E\n要するに状態を保持している一時ファイルが駄目になっているので、それを直接消してやればいい\u003C/p\u003E\n\n\u003Cul\u003E\n\u003Cli\u003ELibreOfficeを終了（強制終了）しておく \u003C/li\u003E\n\u003Cli\u003EFinderでライブラリを開く （Finderの移動メニューを押して、Optionキーをおすとでてくる）\u003C/li\u003E\n\u003Cli\u003E\u003Ccode\u003ESaved Application State\u003C/code\u003E というディレクトリの \u003Ccode\u003Eorg.libreoffice.script.savedState\u003C/code\u003Eというディレクトリを開く\u003C/li\u003E\n\u003Cli\u003E中のファイルを全部消す（多分全部消さなくてもいいけど、不明）\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cp\u003EOpenOfficeでもディレクトリ名などが違うだけで多分同じ。\u003C/p\u003E\n"},{"id":24612,"uuid":"64f9aa5af61b19f934bd","user":{"id":25380,"url_name":"ballforest","profile_image_url":"https://si0.twimg.com/profile_images/2421137085/r8gs0302skjndlzmhhhw_normal.jpeg"},"title":"Emacsで日本語/英語音声合成","created_at":"2013-08-14 08:59:01 +0900","updated_at":"2013-08-14 08:59:01 +0900","created_at_in_words":"3時間前","updated_at_in_words":"3時間前","tags":[{"name":"Emacs","url_name":"emacs","icon_url":"https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/2920f41f5aefd36267c6c04183d7e6197b4d2b99/medium.jpg?1364837723","versions":[]}],"stock_count":0,"stock_users":[],"comment_count":0,"lgtm_count":0,"url":"http://qiita.com/ballforest/items/64f9aa5af61b19f934bd","gist_url":null,"tweet":true,"private":false,"created_at_as_seconds":1376438341,"raw_body":"表題について，かつて記事を書いたので，メモとして残しておく．\nhttp://tam5917.hatenablog.com/entry/20130425/1366887458","body":"\u003Cp\u003E表題について，かつて記事を書いたので，メモとして残しておく．\u003Cbr\u003E\n\u003Ca href=\"http://tam5917.hatenablog.com/entry/20130425/1366887458\" title=\"http://tam5917.hatenablog.com/entry/20130425/1366887458\" target=\"_blank\"\u003Ehttp://tam5917.hatenablog.com/entry/20130425/1366887458\u003C/a\u003E\u003C/p\u003E\n"},{"id":24611,"uuid":"6700916be1b88e6f0f85","user":{"id":18159,"url_name":"tsuyosh","profile_image_url":"https://si0.twimg.com/profile_images/2437569175/ol7aj6u87oo6iqqz3yt3_normal.jpeg"},"title":"Volleyを無理矢理file schemeに対応してみる","created_at":"2013-08-14 06:44:48 +0900","updated_at":"2013-08-14 06:44:48 +0900","created_at_in_words":"5時間前","updated_at_in_words":"5時間前","tags":[{"name":"Android","url_name":"android","icon_url":"https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/aad12dc3e9bb53d572b20b2f908f584439bf18a5/medium.jpg?1364838011","versions":[]},{"name":"Volley","url_name":"volley","icon_url":"/icons/medium/missing.png","versions":[]}],"stock_count":1,"stock_users":["akihito104"],"comment_count":0,"lgtm_count":0,"url":"http://qiita.com/tsuyosh/items/6700916be1b88e6f0f85","gist_url":null,"tweet":false,"private":false,"created_at_as_seconds":1376430288,"raw_body":"\nNetworkImageView#setImageUrl(String, ImageLoader)はfileスキームに未対応なので扱えるように改造してみました\n\nBasicNetwork#performRequest()メソッドをOverrideしてfile schemeの場合はFileInputStream経由でデータを取得するようにしたらあっさりできました。\n\n```java:CustomNetwork.java\npackage com.example.volleysample;\n\nimport java.io.ByteArrayOutputStream;\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.io.IOException;\nimport java.io.InputStream;\nimport java.util.Collections;\n\nimport org.apache.http.HttpStatus;\n\nimport android.net.Uri;\nimport android.util.Log;\n\nimport com.android.volley.NetworkError;\nimport com.android.volley.NetworkResponse;\nimport com.android.volley.Request;\nimport com.android.volley.VolleyError;\nimport com.android.volley.toolbox.BasicNetwork;\nimport com.android.volley.toolbox.ByteArrayPool;\nimport com.android.volley.toolbox.HttpStack;\nimport com.example.volleysample.BuildConfig;\n\npublic class CustomNetwork extends BasicNetwork {\n\tprivate static final String TAG = CustomNetwork.class.getSimpleName();\n\n\tpublic CustomNetwork(HttpStack stack) {\n\t\tsuper(stack);\n\t}\n\n\tpublic CustomNetwork(HttpStack stack, ByteArrayPool pool) {\n\t\tsuper(stack, pool);\n\t}\n\n\t@Override\n\tpublic NetworkResponse performRequest(Request\u003C?\u003E request)\n\t\t\tthrows VolleyError {\n\t\t// file schemeの場合は自前で処理\n\t\tUri uri = Uri.parse(request.getUrl());\n\t\tif (uri != null \u0026\u0026 \"file\".equals(uri.getScheme())) {\n\t\t\treturn performFileRequest(uri);\n\t\t}\n\n\t\t// file scheme以外の処理は親クラスに丸投げ\n\t\treturn super.performRequest(request);\n\t}\n\n\tprivate NetworkResponse performFileRequest(Uri uri) throws VolleyError {\n\t\tFile file = new File(uri.getPath());\n\t\tNetworkResponse response;\n\t\tif (file.exists()) {\n\t\t\tbyte[] data = readBytes(file);\n\t\t\tresponse = new NetworkResponse(data);\n\t\t} else {\n\t\t\t// 404エラーを返す\n\t\t\tif (BuildConfig.DEBUG)\n\t\t\t\tLog.w(TAG, \"performFileRequest: file not found: \" + file);\n\t\t\tresponse = new NetworkResponse(HttpStatus.SC_NOT_FOUND, null,\n\t\t\t\t\tCollections.\u003CString, String\u003E emptyMap(), false);\n\t\t}\n\t\treturn response;\n\t}\n\n\tprivate byte[] readBytes(File file) throws VolleyError {\n\t\tif (BuildConfig.DEBUG) Log.d(TAG, \"readBytes: reading data from \" + file);\n\t\tbyte[] data = null;\n\t\ttry {\n\t\t\tByteArrayOutputStream out = new ByteArrayOutputStream();\n\t\t\tInputStream in = null;\n\t\t\ttry {\n\t\t\t\tin = new FileInputStream(file);\n\t\t\t\tbyte[] buf = new byte[1024];\n\t\t\t\tint len = 0;\n\t\t\t\twhile ((len = in.read(buf, 0, buf.length)) \u003E= 0) {\n\t\t\t\t\tout.write(buf, 0, len);\n\t\t\t\t}\n\t\t\t\tdata = out.toByteArray();\n\t\t\t\tif (BuildConfig.DEBUG) Log.d(TAG, \"readBytes: read \" + data.length + \" bytes.\");\n\t\t\t} finally {\n\t\t\t\tif (in != null) in.close();\n\t\t\t\tif (out != null) out.close();\n\t\t\t}\n\t\t} catch (IOException e) {\n\t\t\tif (BuildConfig.DEBUG) Log.w(TAG, \"readBytes: failed to read data\", e);\n\t\t\tthrow new NetworkError(e);\n\t\t}\n\t\treturn data;\n\t}\n}\n\n```\n\n実際に使う場合にはRequestQueueのコンストラクターにCustomNetworkのインスタンスを渡します。\n\n```java\n    public static RequestQueue createRequestQueue(Context context, HttpStack stack, int maxCacheSizeInBytes) {\n        File cacheDir = new File(context.getCacheDir(), DEFAULT_CACHE_DIR);\n\n        String userAgent = \"volley/0\";\n        try {\n            String packageName = context.getPackageName();\n\n            PackageInfo info = context.getPackageManager().getPackageInfo(packageName, 0);\n            userAgent = packageName + \"/\" + info.versionCode;\n        } catch (NameNotFoundException e) {\n        }\n\n        if (stack == null) {\n            if (Build.VERSION.SDK_INT \u003E= 9) {\n                stack = new HurlStack();\n            } else {\n                // Prior to Gingerbread, HttpUrlConnection was unreliable.\n                // See: http://android-developers.blogspot.com/2011/09/androids-http-clients.html\n                stack = new HttpClientStack(AndroidHttpClient.newInstance(userAgent));\n            }\n        }\n\n//        Network network = new BasicNetwork(stack);\n        Network network = new CustomNetwork(stack); // ここだけ修正\n\n        RequestQueue queue = new RequestQueue(new DiskBasedCache(cacheDir, maxCacheSizeInBytes), network);\n        queue.start();\n\n        return queue;\n\t}\n\n```\n","body":"\u003Cp\u003ENetworkImageView#setImageUrl(String, ImageLoader)はfileスキームに未対応なので扱えるように改造してみました\u003C/p\u003E\n\u003Cp\u003EBasicNetwork#performRequest()メソッドをOverrideしてfile schemeの場合はFileInputStream経由でデータを取得するようにしたらあっさりできました。\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"code-lang\"\u003E\u003Cspan class=\"bold\"\u003ECustomNetwork.java\u003C/span\u003E\u003C/div\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Cspan class=\"kn\"\u003Epackage\u003C/span\u003E \u003Cspan class=\"n\"\u003Ecom\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Eexample\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Evolleysample\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Ejava.io.ByteArrayOutputStream\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Ejava.io.File\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Ejava.io.FileInputStream\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Ejava.io.IOException\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Ejava.io.InputStream\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Ejava.util.Collections\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Eorg.apache.http.HttpStatus\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Eandroid.net.Uri\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Eandroid.util.Log\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Ecom.android.volley.NetworkError\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Ecom.android.volley.NetworkResponse\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Ecom.android.volley.Request\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Ecom.android.volley.VolleyError\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Ecom.android.volley.toolbox.BasicNetwork\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Ecom.android.volley.toolbox.ByteArrayPool\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Ecom.android.volley.toolbox.HttpStack\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"nn\"\u003Ecom.example.volleysample.BuildConfig\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n\n\u003Cspan class=\"kd\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"kd\"\u003Eclass\u003C/span\u003E \u003Cspan class=\"nc\"\u003ECustomNetwork\u003C/span\u003E \u003Cspan class=\"kd\"\u003Eextends\u003C/span\u003E \u003Cspan class=\"n\"\u003EBasicNetwork\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n    \u003Cspan class=\"kd\"\u003Eprivate\u003C/span\u003E \u003Cspan class=\"kd\"\u003Estatic\u003C/span\u003E \u003Cspan class=\"kd\"\u003Efinal\u003C/span\u003E \u003Cspan class=\"n\"\u003EString\u003C/span\u003E \u003Cspan class=\"n\"\u003ETAG\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003ECustomNetwork\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Eclass\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetSimpleName\u003C/span\u003E\u003Cspan class=\"o\"\u003E();\u003C/span\u003E\n\n    \u003Cspan class=\"kd\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"nf\"\u003ECustomNetwork\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EHttpStack\u003C/span\u003E \u003Cspan class=\"n\"\u003Estack\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"kd\"\u003Esuper\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Estack\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"kd\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"nf\"\u003ECustomNetwork\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EHttpStack\u003C/span\u003E \u003Cspan class=\"n\"\u003Estack\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003EByteArrayPool\u003C/span\u003E \u003Cspan class=\"n\"\u003Epool\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"kd\"\u003Esuper\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Estack\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Epool\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"nd\"\u003E@Override\u003C/span\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"n\"\u003ENetworkResponse\u003C/span\u003E \u003Cspan class=\"nf\"\u003EperformRequest\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003ERequest\u003C/span\u003E\u003Cspan class=\"o\"\u003E\u0026lt;?\u0026gt;\u003C/span\u003E \u003Cspan class=\"n\"\u003Erequest\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E\n            \u003Cspan class=\"kd\"\u003Ethrows\u003C/span\u003E \u003Cspan class=\"n\"\u003EVolleyError\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"c1\"\u003E// file schemeの場合は自前で処理\u003C/span\u003E\n        \u003Cspan class=\"n\"\u003EUri\u003C/span\u003E \u003Cspan class=\"n\"\u003Euri\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003EUri\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Eparse\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Erequest\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetUrl\u003C/span\u003E\u003Cspan class=\"o\"\u003E());\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Euri\u003C/span\u003E \u003Cspan class=\"o\"\u003E!=\u003C/span\u003E \u003Cspan class=\"kc\"\u003Enull\u003C/span\u003E \u003Cspan class=\"o\"\u003E\u0026amp;\u0026amp;\u003C/span\u003E \u003Cspan class=\"s\"\u003E\u0026quot;file\u0026quot;\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Eequals\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Euri\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetScheme\u003C/span\u003E\u003Cspan class=\"o\"\u003E()))\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"nf\"\u003EperformFileRequest\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Euri\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n\n        \u003Cspan class=\"c1\"\u003E// file scheme以外の処理は親クラスに丸投げ\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"kd\"\u003Esuper\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EperformRequest\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Erequest\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"kd\"\u003Eprivate\u003C/span\u003E \u003Cspan class=\"n\"\u003ENetworkResponse\u003C/span\u003E \u003Cspan class=\"nf\"\u003EperformFileRequest\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EUri\u003C/span\u003E \u003Cspan class=\"n\"\u003Euri\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C/span\u003E \u003Cspan class=\"n\"\u003EVolleyError\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"n\"\u003EFile\u003C/span\u003E \u003Cspan class=\"n\"\u003Efile\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"n\"\u003EFile\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Euri\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetPath\u003C/span\u003E\u003Cspan class=\"o\"\u003E());\u003C/span\u003E\n        \u003Cspan class=\"n\"\u003ENetworkResponse\u003C/span\u003E \u003Cspan class=\"n\"\u003Eresponse\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Efile\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Eexists\u003C/span\u003E\u003Cspan class=\"o\"\u003E())\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n            \u003Cspan class=\"kt\"\u003Ebyte\u003C/span\u003E\u003Cspan class=\"o\"\u003E[]\u003C/span\u003E \u003Cspan class=\"n\"\u003Edata\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003EreadBytes\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Efile\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n            \u003Cspan class=\"n\"\u003Eresponse\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"n\"\u003ENetworkResponse\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Edata\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C/span\u003E \u003Cspan class=\"k\"\u003Eelse\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n            \u003Cspan class=\"c1\"\u003E// 404エラーを返す\u003C/span\u003E\n            \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EBuildConfig\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EDEBUG\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E\n                \u003Cspan class=\"n\"\u003ELog\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Ew\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003ETAG\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"s\"\u003E\u0026quot;performFileRequest: file not found: \u0026quot;\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"n\"\u003Efile\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n            \u003Cspan class=\"n\"\u003Eresponse\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"n\"\u003ENetworkResponse\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EHttpStatus\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003ESC_NOT_FOUND\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"kc\"\u003Enull\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E\n                    \u003Cspan class=\"n\"\u003ECollections\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u0026lt;\u003C/span\u003E\u003Cspan class=\"n\"\u003EString\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003EString\u003C/span\u003E\u003Cspan class=\"o\"\u003E\u0026gt;\u003C/span\u003E \u003Cspan class=\"n\"\u003EemptyMap\u003C/span\u003E\u003Cspan class=\"o\"\u003E(),\u003C/span\u003E \u003Cspan class=\"kc\"\u003Efalse\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"n\"\u003Eresponse\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n\n    \u003Cspan class=\"kd\"\u003Eprivate\u003C/span\u003E \u003Cspan class=\"kt\"\u003Ebyte\u003C/span\u003E\u003Cspan class=\"o\"\u003E[]\u003C/span\u003E \u003Cspan class=\"nf\"\u003EreadBytes\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EFile\u003C/span\u003E \u003Cspan class=\"n\"\u003Efile\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C/span\u003E \u003Cspan class=\"n\"\u003EVolleyError\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EBuildConfig\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EDEBUG\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"n\"\u003ELog\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Ed\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003ETAG\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"s\"\u003E\u0026quot;readBytes: reading data from \u0026quot;\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"n\"\u003Efile\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n        \u003Cspan class=\"kt\"\u003Ebyte\u003C/span\u003E\u003Cspan class=\"o\"\u003E[]\u003C/span\u003E \u003Cspan class=\"n\"\u003Edata\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"kc\"\u003Enull\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Etry\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n            \u003Cspan class=\"n\"\u003EByteArrayOutputStream\u003C/span\u003E \u003Cspan class=\"n\"\u003Eout\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"n\"\u003EByteArrayOutputStream\u003C/span\u003E\u003Cspan class=\"o\"\u003E();\u003C/span\u003E\n            \u003Cspan class=\"n\"\u003EInputStream\u003C/span\u003E \u003Cspan class=\"n\"\u003Ein\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"kc\"\u003Enull\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n            \u003Cspan class=\"k\"\u003Etry\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n                \u003Cspan class=\"n\"\u003Ein\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"n\"\u003EFileInputStream\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Efile\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n                \u003Cspan class=\"kt\"\u003Ebyte\u003C/span\u003E\u003Cspan class=\"o\"\u003E[]\u003C/span\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"kt\"\u003Ebyte\u003C/span\u003E\u003Cspan class=\"o\"\u003E[\u003C/span\u003E\u003Cspan class=\"mi\"\u003E1024\u003C/span\u003E\u003Cspan class=\"o\"\u003E];\u003C/span\u003E\n                \u003Cspan class=\"kt\"\u003Eint\u003C/span\u003E \u003Cspan class=\"n\"\u003Elen\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"mi\"\u003E0\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n                \u003Cspan class=\"k\"\u003Ewhile\u003C/span\u003E \u003Cspan class=\"o\"\u003E((\u003C/span\u003E\u003Cspan class=\"n\"\u003Elen\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Ein\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Eread\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"mi\"\u003E0\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Elength\u003C/span\u003E\u003Cspan class=\"o\"\u003E))\u003C/span\u003E \u003Cspan class=\"o\"\u003E\u0026gt;=\u003C/span\u003E \u003Cspan class=\"mi\"\u003E0\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n                    \u003Cspan class=\"n\"\u003Eout\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Ewrite\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"mi\"\u003E0\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Elen\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n                \u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n                \u003Cspan class=\"n\"\u003Edata\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Eout\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EtoByteArray\u003C/span\u003E\u003Cspan class=\"o\"\u003E();\u003C/span\u003E\n                \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EBuildConfig\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EDEBUG\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"n\"\u003ELog\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Ed\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003ETAG\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"s\"\u003E\u0026quot;readBytes: read \u0026quot;\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"n\"\u003Edata\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Elength\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"s\"\u003E\u0026quot; bytes.\u0026quot;\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C/span\u003E \u003Cspan class=\"k\"\u003Efinally\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n                \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ein\u003C/span\u003E \u003Cspan class=\"o\"\u003E!=\u003C/span\u003E \u003Cspan class=\"kc\"\u003Enull\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"n\"\u003Ein\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Eclose\u003C/span\u003E\u003Cspan class=\"o\"\u003E();\u003C/span\u003E\n                \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Eout\u003C/span\u003E \u003Cspan class=\"o\"\u003E!=\u003C/span\u003E \u003Cspan class=\"kc\"\u003Enull\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"n\"\u003Eout\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Eclose\u003C/span\u003E\u003Cspan class=\"o\"\u003E();\u003C/span\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C/span\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C/span\u003E \u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EIOException\u003C/span\u003E \u003Cspan class=\"n\"\u003Ee\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n            \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EBuildConfig\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EDEBUG\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"n\"\u003ELog\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Ew\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003ETAG\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"s\"\u003E\u0026quot;readBytes: failed to read data\u0026quot;\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Ee\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n            \u003Cspan class=\"k\"\u003Ethrow\u003C/span\u003E \u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"nf\"\u003ENetworkError\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ee\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"n\"\u003Edata\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n\u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\u003Cp\u003E実際に使う場合にはRequestQueueのコンストラクターにCustomNetworkのインスタンスを渡します。\u003C/p\u003E\n\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E    \u003Cspan class=\"kd\"\u003Epublic\u003C/span\u003E \u003Cspan class=\"kd\"\u003Estatic\u003C/span\u003E \u003Cspan class=\"n\"\u003ERequestQueue\u003C/span\u003E \u003Cspan class=\"nf\"\u003EcreateRequestQueue\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EContext\u003C/span\u003E \u003Cspan class=\"n\"\u003Econtext\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003EHttpStack\u003C/span\u003E \u003Cspan class=\"n\"\u003Estack\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"kt\"\u003Eint\u003C/span\u003E \u003Cspan class=\"n\"\u003EmaxCacheSizeInBytes\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"n\"\u003EFile\u003C/span\u003E \u003Cspan class=\"n\"\u003EcacheDir\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"n\"\u003EFile\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Econtext\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetCacheDir\u003C/span\u003E\u003Cspan class=\"o\"\u003E(),\u003C/span\u003E \u003Cspan class=\"n\"\u003EDEFAULT_CACHE_DIR\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n\n        \u003Cspan class=\"n\"\u003EString\u003C/span\u003E \u003Cspan class=\"n\"\u003EuserAgent\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"s\"\u003E\u0026quot;volley/0\u0026quot;\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Etry\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n            \u003Cspan class=\"n\"\u003EString\u003C/span\u003E \u003Cspan class=\"n\"\u003EpackageName\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Econtext\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetPackageName\u003C/span\u003E\u003Cspan class=\"o\"\u003E();\u003C/span\u003E\n\n            \u003Cspan class=\"n\"\u003EPackageInfo\u003C/span\u003E \u003Cspan class=\"n\"\u003Einfo\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Econtext\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetPackageManager\u003C/span\u003E\u003Cspan class=\"o\"\u003E().\u003C/span\u003E\u003Cspan class=\"na\"\u003EgetPackageInfo\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EpackageName\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"mi\"\u003E0\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n            \u003Cspan class=\"n\"\u003EuserAgent\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003EpackageName\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"s\"\u003E\u0026quot;/\u0026quot;\u003C/span\u003E \u003Cspan class=\"o\"\u003E+\u003C/span\u003E \u003Cspan class=\"n\"\u003Einfo\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EversionCode\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C/span\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C/span\u003E \u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003ENameNotFoundException\u003C/span\u003E \u003Cspan class=\"n\"\u003Ee\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n\n        \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Estack\u003C/span\u003E \u003Cspan class=\"o\"\u003E==\u003C/span\u003E \u003Cspan class=\"kc\"\u003Enull\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n            \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EBuild\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EVERSION\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003ESDK_INT\u003C/span\u003E \u003Cspan class=\"o\"\u003E\u0026gt;=\u003C/span\u003E \u003Cspan class=\"mi\"\u003E9\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n                \u003Cspan class=\"n\"\u003Estack\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"n\"\u003EHurlStack\u003C/span\u003E\u003Cspan class=\"o\"\u003E();\u003C/span\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C/span\u003E \u003Cspan class=\"k\"\u003Eelse\u003C/span\u003E \u003Cspan class=\"o\"\u003E{\u003C/span\u003E\n                \u003Cspan class=\"c1\"\u003E// Prior to Gingerbread, HttpUrlConnection was unreliable.\u003C/span\u003E\n                \u003Cspan class=\"c1\"\u003E// See: http://android-developers.blogspot.com/2011/09/androids-http-clients.html\u003C/span\u003E\n                \u003Cspan class=\"n\"\u003Estack\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"n\"\u003EHttpClientStack\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EAndroidHttpClient\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003EnewInstance\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EuserAgent\u003C/span\u003E\u003Cspan class=\"o\"\u003E));\u003C/span\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n\n\u003Cspan class=\"c1\"\u003E//        Network network = new BasicNetwork(stack);\u003C/span\u003E\n        \u003Cspan class=\"n\"\u003ENetwork\u003C/span\u003E \u003Cspan class=\"n\"\u003Enetwork\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"n\"\u003ECustomNetwork\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Estack\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E \u003Cspan class=\"c1\"\u003E// ここだけ修正\u003C/span\u003E\n\n        \u003Cspan class=\"n\"\u003ERequestQueue\u003C/span\u003E \u003Cspan class=\"n\"\u003Equeue\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"n\"\u003ERequestQueue\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"k\"\u003Enew\u003C/span\u003E \u003Cspan class=\"n\"\u003EDiskBasedCache\u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EcacheDir\u003C/span\u003E\u003Cspan class=\"o\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003EmaxCacheSizeInBytes\u003C/span\u003E\u003Cspan class=\"o\"\u003E),\u003C/span\u003E \u003Cspan class=\"n\"\u003Enetwork\u003C/span\u003E\u003Cspan class=\"o\"\u003E);\u003C/span\u003E\n        \u003Cspan class=\"n\"\u003Equeue\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"na\"\u003Estart\u003C/span\u003E\u003Cspan class=\"o\"\u003E();\u003C/span\u003E\n\n        \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"n\"\u003Equeue\u003C/span\u003E\u003Cspan class=\"o\"\u003E;\u003C/span\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E"},{"id":24610,"uuid":"7c058370811d4d19dbcd","user":{"id":20266,"url_name":"hachi8833","profile_image_url":"https://si0.twimg.com/profile_images/57617498/20080802112526_normal.jpg"},"title":"ドットインストールを使わない手はない","created_at":"2013-08-14 05:53:32 +0900","updated_at":"2013-08-14 05:53:32 +0900","created_at_in_words":"6時間前","updated_at_in_words":"6時間前","tags":[{"name":"ドットインストール","url_name":"%e3%83%89%e3%83%83%e3%83%88%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab","icon_url":"/icons/medium/missing.png","versions":[]}],"stock_count":1,"stock_users":["ishioh@github"],"comment_count":0,"lgtm_count":0,"url":"http://qiita.com/hachi8833/items/7c058370811d4d19dbcd","gist_url":null,"tweet":false,"private":false,"created_at_as_seconds":1376427212,"raw_body":"\nhttp://dotinstall.com/\n\n「3分動画でマスターするプログラミング学習サイト」を謳うこのサイト、実に素晴らしい。動画コンテンツなので、ググってもなかなか出てこない。\n\nすべて入門編とはいえ、扱っている言語の範囲が恐ろしく広く、LuaやScratch、大昔のBasicまである。ないのはlisp, scheme系ぐらいか。\n\n言語にとどまらず、Unixの基本操作や、PHP+SQLローカル開発環境の構築方法や、Git、Sublime TextやVim、Emacsの使い方まである。\n\nたとえばCoffeeScriptは、3分足らずの動画が13で、小一時間で終わる分量。\nhttp://dotinstall.com/lessons/basic_coffeescript\n\n何かの言語の概要を急いで習得したい場合や、独学で習得した項目の漏れを確認する場合に非常にありがたい。\n\nhttp://webhoo.net/2013/04/01/dotinstall-3-study-method/","body":"\u003Cp\u003E\u003Ca href=\"http://dotinstall.com/\" title=\"http://dotinstall.com/\" target=\"_blank\"\u003Ehttp://dotinstall.com/\u003C/a\u003E\u003C/p\u003E\n\u003Cp\u003E「3分動画でマスターするプログラミング学習サイト」を謳うこのサイト、実に素晴らしい。動画コンテンツなので、ググってもなかなか出てこない。\u003C/p\u003E\n\u003Cp\u003Eすべて入門編とはいえ、扱っている言語の範囲が恐ろしく広く、LuaやScratch、大昔のBasicまである。ないのはlisp, scheme系ぐらいか。\u003C/p\u003E\n\u003Cp\u003E言語にとどまらず、Unixの基本操作や、PHP+SQLローカル開発環境の構築方法や、Git、Sublime TextやVim、Emacsの使い方まである。\u003C/p\u003E\n\u003Cp\u003EたとえばCoffeeScriptは、3分足らずの動画が13で、小一時間で終わる分量。\u003Cbr\u003E\n\u003Ca href=\"http://dotinstall.com/lessons/basic_coffeescript\" title=\"http://dotinstall.com/lessons/basic_coffeescript\" target=\"_blank\"\u003Ehttp://dotinstall.com/lessons/basic_coffeescript\u003C/a\u003E\u003C/p\u003E\n\u003Cp\u003E何かの言語の概要を急いで習得したい場合や、独学で習得した項目の漏れを確認する場合に非常にありがたい。\u003C/p\u003E\n\u003Cp\u003E\u003Ca href=\"http://webhoo.net/2013/04/01/dotinstall-3-study-method/\" title=\"http://webhoo.net/2013/04/01/dotinstall-3-study-method/\" target=\"_blank\"\u003Ehttp://webhoo.net/2013/04/01/dotinstall-3-study-method/\u003C/a\u003E\u003C/p\u003E\n"},{"id":24609,"uuid":"316bf6fd22b277cf2aa6","user":{"id":26965,"url_name":"yocifico","profile_image_url":"https://secure.gravatar.com/avatar/536bc81d7c9aebc4f11472253ecc523c?d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-user-420.png"},"title":"テキストファイルを一括でiconv","created_at":"2013-08-14 05:08:48 +0900","updated_at":"2013-08-14 05:08:48 +0900","created_at_in_words":"7時間前","updated_at_in_words":"7時間前","tags":[{"name":"shell","url_name":"shell","icon_url":"/icons/medium/missing.png","versions":[]}],"stock_count":1,"stock_users":["ken_c_lo"],"comment_count":0,"lgtm_count":0,"url":"http://qiita.com/yocifico/items/316bf6fd22b277cf2aa6","gist_url":"https://gist.github.com/6225166","tweet":false,"private":false,"created_at_as_seconds":1376424528,"raw_body":"## あるディレクトリ以下のテキストファイルを一括でiconv\n\nバイナリのファイルでもおかまいなしにiconvしちゃうのがなんとなく嫌だったのと、拡張子とかで絞るのが嫌だったのでした。いつもはforとかで回してやってたけど、一撃で倒そうと思っているうちに結局まわりくどい感じになったなあ。\nちなみに ubuntu 3.8.0-19 にて実行。\n\n####例： hogeディレクトリ以下のテキストファイルをすべてEUC-JPからUTF-8に変換して上書き\n\n```bash:\nfind hoge -type f | xargs file | grep  \":.*text\" | cut -d: -f1 | xargs -t -I{} iconv -f EUC-JP -t UTF-8 {} -o {}\n```\n\n- - -\n\n### 解説\n`find hoge -type f`\nhogeディレクトリ以下のファイルのみを`find`\n\n- - -\n\n`xargs file`\n`find`で見つけたファイルの種類を表示\n\n- - -\n\n`grep \":.*text\"`\n\nテキストファイルのみを抽出。\nファイル名にtextを含むケースを考慮して:（コロン）以降で探している。\nバイナリファイルだけを見つけたい（テキストファイル以外をバイナリとするのであれば）場合には、以下のようにすればよい。\n\n```bash:\nfind hoge -type f | xargs file | grep -v  \":.*text\" | cut -d: -f1\n```\n\n- - -\n\n`cut -d: -f1`\n特定したファイルのパスのみを抽出。\n区切り文字を:（コロン）として1フィールド目を抽出している。\n\n- - -\n\n`xargs -t -I{} iconv -f EUC-JP -t UTF-8 {} -o {}`\n\n* `-t` 実行したコマンドを表示するオプション。確認用なのでなくてもよい。\n* `-I{}` xargsの引数を変数のようにして使う。`{}` としたが、好きな文字列でよい。\n* `-f EUC-JP -t UTF-8` EUC-JP から UTF-8 に変換。`iconv -l`で文字コード一覧を確認できる。\n\n- - -\n\n### 注意\n変換して上書きしてしまうので、失敗したとき戻せるようにディレクトリまるごとコピーして作業するのがオススメ。\n同じディレクトリに対して立て続けに何度も実行しないこと。`iconv`のfromとtoがわけのわからないことになるよ。","body":"\u003Ch2\u003E\n        \u003Cspan id=\"2-2\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#2-2\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003Eあるディレクトリ以下のテキストファイルを一括でiconv\n      \u003C/h2\u003E\u003Cp\u003Eバイナリのファイルでもおかまいなしにiconvしちゃうのがなんとなく嫌だったのと、拡張子とかで絞るのが嫌だったのでした。いつもはforとかで回してやってたけど、一撃で倒そうと思っているうちに結局まわりくどい感じになったなあ。\u003Cbr\u003E\nちなみに ubuntu 3.8.0-19 にて実行。\u003C/p\u003E\n\u003Ch4\u003E\n        \u003Cspan id=\"4-2\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#4-2\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003E例： hogeディレクトリ以下のテキストファイルをすべてEUC-JPからUTF-8に変換して上書き\n      \u003C/h4\u003E\u003Cdiv class=\"code-frame\"\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003Efind hoge -type f | xargs file | grep  \u003Cspan class=\"s2\"\u003E\u0026quot;:.*text\u0026quot;\u003C/span\u003E | cut -d: -f1 | xargs -t -I\u003Cspan class=\"o\"\u003E{}\u003C/span\u003E iconv -f EUC-JP -t UTF-8 \u003Cspan class=\"o\"\u003E{}\u003C/span\u003E -o \u003Cspan class=\"o\"\u003E{}\u003C/span\u003E\n\u003C/pre\u003E\u003C/div\u003E\u003C/div\u003E\n\u003Chr\u003E\n\u003Ch3\u003E\n        \u003Cspan id=\"3-3\" class=\"fragment\"\u003E\u003C/span\u003E\n        \u003Ca href=\"#3-3\"\u003E\u003Ci class=\"icon-link\"\u003E\u003C/i\u003E\u003C/a\u003E解説\n      \u003C/h3\u003E\u003Cp\u003E\u003Ccode\u003Efind hoge -type f\u003C/code\u003E\u003Cbr\u003E\nhogeディレクトリ以下のファイルのみを\u003Ccode\u003Efind\u003C/code\u003E\u003C/p\u003E\n\n\u003Chr\u003E\n\u003Cp\u003E\u003Ccode\u003Exargs file\u003C/code\u003E\u003Cbr\u003E\n\u003Ccode\u003Efind\u003C/code\u003Eで見つけたファイルの種類を表示\u003C/p\u003E\n\n\u003Chr\u003E\n\u003Cp\u003E\u003Ccode\u003Egrep \u0026quot;:.*text\u0026quot;\u003C/code\u003E\u